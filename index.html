<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiliaHub - Interactive Ciliary Gene Database</title>
    <style>
        /* --- General Styles & Layout --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: #2c3e50; line-height: 1.6; }
        .main-container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; display: grid; grid-template-columns: 1fr 350px; gap: 2rem; align-items: start; }
        .content-area { display: flex; flex-direction: column; gap: 1.5rem; }
        .content-area-full { grid-column: 1 / -1; } /* Class for full-width content like the Home page intro */

        /* --- Navbar --- */
        .navbar { background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%); padding: 1rem 0; box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2rem; font-weight: bold; color: #ffffff; text-decoration: none; }
        .nav-links { display: flex; list-style: none; gap: 2rem; }
        .nav-links a { color: #e8f4fd; text-decoration: none; padding: 0.5rem 1rem; border-radius: 25px; transition: all 0.3s ease; font-weight: 500; }
        .nav-links a:hover, .nav-links a.active { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }

        /* --- Page Sections & Search Inputs --- */
        .page-section { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1); }
        .search-container { display: flex; gap: 1rem; margin-top: 1rem; }
        #single-gene-search, #batch-genes-input { padding: 1rem; border: 2px solid #e1ecf4; border-radius: 10px; font-size: 1rem; }
        #single-gene-search { flex: 1; }
        #batch-genes-input { width: 100%; min-height: 100px; resize: vertical; margin-top: 1rem; margin-bottom: 1rem; }
        .search-btn { padding: 1rem 2rem; background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        
        /* --- Gene Cards --- */
        .gene-cards { display: grid; gap: 1.5rem; }
        .gene-card { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1); transition: all 0.3s ease; border-left: 5px solid transparent; }
        .gene-card:hover { transform: translateY(-5px); }
        .gene-card.default { border-left-color: #e74c3c; }
        .gene-card.search-result { border-left-color: #27ae60; }
        .gene-name { font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem; }
        .gene-card.default .gene-name { color: #c0392b; }
        .gene-card.search-result .gene-name { color: #27ae60; }
        .gene-description { color: #7f8c8d; font-size: 0.95rem; }

        /* --- Cilia Panel (Right Sidebar) --- */
        .cilia-panel { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1); position: sticky; top: 100px; height: fit-content; }
        .panel-header { background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%); color: white; padding: 1.5rem; text-align: center; }
        .panel-content { padding: 1.5rem; }
        .cilia-part { stroke: #2c3e50; stroke-width: 1.5; transition: all 0.3s ease-in-out; cursor: pointer; }
        .highlighted { fill: #e74c3c !important; opacity: 0.9 !important; animation: pulse 2s infinite; }
        .highlighted.search-gene { fill: #27ae60 !important; }
        @keyframes pulse { 0%, 100% { opacity: 0.9; } 50% { opacity: 0.6; } }
        .controls { background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-top: 1rem; }
        .gene-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
        .gene-btn { padding: 0.7rem; border: 1px solid #e1ecf4; border-radius: 8px; background: white; cursor: pointer; font-weight: 600; }
        .gene-btn.default { color: #c0392b; }
        .gene-btn.search-gene { background: #27ae60; color: white; border-color: #27ae60; }
        .reset-btn { background: #95a5a6 !important; color: white !important; margin-top: 0.5rem; }
        .status-message { text-align: center; padding: 3rem; color: #7f8c8d; font-style: italic; }

        /* --- Responsive Design --- */
        @media (max-width: 992px) { .main-container { grid-template-columns: 1fr; } .cilia-panel { position: relative; top: auto; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" onclick="navigateTo(event, '/')" class="logo">CiliaHub</a>
            <ul class="nav-links">
                <li><a href="/" onclick="navigateTo(event, '/')">Home</a></li>
                <li><a href="/batch-query" onclick="navigateTo(event, '/batch-query')">Batch Query</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <div class="content-area"></div>
        <aside class="cilia-panel" style="display: none;"></aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Application State ---
            const geneLocalizationData = {};
            let allGenes = [];
            let defaultGenes = [];
            const contentArea = document.querySelector('.content-area');
            const ciliaPanel = document.querySelector('.cilia-panel');

            // --- Database and Utility Functions ---
            async function loadGeneDatabase() {
                if (allGenes.length > 0) return; // Prevent re-fetching
                try {
                    const response = await fetch('ciliahub_data.json');
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const data = await response.json();
                    allGenes = data;
                    defaultGenes = data.slice(0, 3);
                    data.forEach(gene => {
                        if (gene.localization) {
                            const mapping = {'ciliary membrane': 'ciliary-membrane', 'axoneme': 'axoneme', 'transition zone': 'transition-zone', 'basal body': 'basal-body'};
                            geneLocalizationData[gene.gene] = gene.localization.split(',').map(p => mapping[p.trim().toLowerCase()]).filter(Boolean);
                        }
                    });
                } catch (error) {
                    contentArea.innerHTML = `<div class="status-message">Failed to load gene database.</div>`;
                }
            }

            // --- Routing and Page Rendering ---
            async function handleRouteChange() {
                await loadGeneDatabase();
                const path = window.location.pathname.toLowerCase();
                const geneName = path.split('/').pop().toUpperCase();
                const gene = allGenes.find(g => g.gene.toUpperCase() === geneName);

                updateActiveNav(path);

                if (path === '/' || path === '/index.html') {
                    displayHomePage();
                } else if (path === '/batch-query') {
                    displayBatchQueryTool();
                } else if (gene) {
                    displayIndividualGenePage(gene);
                } else {
                    displayNotFoundPage();
                }
            }
            
            function displayHomePage() {
                contentArea.className = 'content-area content-area-full';
                ciliaPanel.style.display = 'none'; // Hide cilia panel on home page
                contentArea.innerHTML = `
                    <div class="page-section">
                        <h1>Welcome to CiliaHub</h1>
                        <p style="font-size: 1.1rem; color: #555;">The central resource for interactive ciliary gene data. Use the search below to find a single gene, or navigate to the <strong>Batch Query</strong> tool to search for multiple genes at once.</p>
                        <div class="search-container">
                            <input type="text" id="single-gene-search" placeholder="Search for a single gene (e.g., ARL13B)...">
                            <button id="single-search-btn" class="search-btn">Search</button>
                        </div>
                         <div id="gene-cards-container" class="gene-cards"></div>
                         <div id="status-message" class="status-message" style="display: none;"></div>
                    </div>`;
                document.getElementById('single-search-btn').onclick = performSingleSearch;
                document.getElementById('single-gene-search').onkeydown = (e) => { if (e.key === 'Enter') performSingleSearch(); };
            }

            function displayBatchQueryTool() {
                contentArea.className = 'content-area';
                ciliaPanel.style.display = 'block';
                contentArea.innerHTML = `
                    <div class="page-section">
                        <h2>Batch Gene Query</h2>
                        <label for="batch-genes-input">Enter multiple gene names (comma, space, or newline separated):</label>
                        <textarea id="batch-genes-input" placeholder="e.g., ARL13B, CEP290, IFT88"></textarea>
                        <button id="batch-search-btn" class="search-btn">Search Genes</button>
                    </div>
                    <div id="gene-cards-container" class="gene-cards"></div>
                    <div id="status-message" class="status-message" style="display: none;"></div>`;
                document.getElementById('batch-search-btn').onclick = performBatchSearch;
                displayGeneCards(defaultGenes, []);
            }

            function displayIndividualGenePage(gene) {
                contentArea.className = 'content-area';
                ciliaPanel.style.display = 'block';
                contentArea.innerHTML = `
                    <div class="gene-card search-result" style="cursor: default;">
                        <a href="#" onclick="window.history.back(); return false;">← Back</a>
                        <h1 class="gene-name" style="font-size: 2.5rem; margin-top: 1rem;">${gene.gene}</h1>
                        <p class="gene-description" style="font-size: 1.1rem;">${gene.description}</p>
                        <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid #eee;" />
                        <p><strong>Functional Summary:</strong> ${gene.functional_summary || 'N/A'}</p>
                        <p><strong>Ensembl ID:</strong> <a href="https://www.ensembl.org/id/${gene.ensembl_id}" target="_blank">${gene.ensembl_id}</a></p>
                        <p><strong>OMIM ID:</strong> ${gene.omim_id ? `<a href="https://omim.org/entry/${gene.omim_id}" target="_blank">${gene.omim_id}</a>` : 'N/A'}</p>
                    </div>`;
                updateGeneButtons([gene], [gene]);
                showLocalization(gene.gene, true);
            }
            
            function displayNotFoundPage() {
                contentArea.className = 'content-area content-area-full';
                ciliaPanel.style.display = 'none';
                contentArea.innerHTML = `<div class="page-section status-message"><h2>404 - Gene Not Found</h2></div>`;
            }

            // --- Search and UI Update Logic ---
            function performSingleSearch() {
                const query = document.getElementById('single-gene-search').value.trim().toUpperCase();
                if (!query) return;
                const results = allGenes.filter(g => g.gene.toUpperCase().includes(query));
                
                if (results.length === 1) {
                    navigateTo(null, `/${results[0].gene}`);
                } else if (results.length > 1) {
                    navigateTo(null, '/batch-query');
                    setTimeout(() => { // Wait for batch query page to render
                        document.getElementById('batch-genes-input').value = query;
                        performBatchSearch();
                    }, 100);
                } else {
                    const statusDiv = document.getElementById('status-message');
                    statusDiv.textContent = 'No matching genes found.';
                    statusDiv.style.display = 'block';
                    document.getElementById('gene-cards-container').innerHTML = '';
                }
            }

            function performBatchSearch() {
                const queries = document.getElementById('batch-genes-input').value.split(/[\s,\n]+/).filter(Boolean).map(q => q.trim().toUpperCase());
                const statusDiv = document.getElementById('status-message');
                if (queries.length === 0) return;
                const searchResults = allGenes.filter(g => queries.some(q => g.gene.toUpperCase().includes(q)));
                if (searchResults.length > 0) {
                    statusDiv.style.display = 'none';
                    displayGeneCards(defaultGenes, searchResults);
                } else {
                    statusDiv.textContent = 'No matching genes found from your query.';
                    statusDiv.style.display = 'block';
                    displayGeneCards(defaultGenes, []);
                }
            }

            function displayGeneCards(defaults, searchResults) {
                const container = document.getElementById('gene-cards-container');
                if (!container) return;
                const uniqueDefaults = defaults.filter(d => !searchResults.some(s => s.gene === d.gene));
                const allGenesToDisplay = [...uniqueDefaults, ...searchResults];
                container.innerHTML = allGenesToDisplay.map(gene => {
                    const isSearchResult = searchResults.some(s => s.gene === gene.gene);
                    return `
                        <div class="gene-card ${isSearchResult ? 'search-result' : 'default'}" style="cursor: pointer;" onclick="navigateTo(event, '/${gene.gene}')">
                            <div class="gene-name">${gene.gene}</div>
                            <div class="gene-description">${gene.description}</div>
                            <div style="margin-top: 1rem; font-size: 0.9rem; color: #555;">Click to view more details →</div>
                        </div>`;
                }).join('');
                updateGeneButtons(allGenesToDisplay, searchResults);
            }

            function updateGeneButtons(genesToDisplay, searchResults = []) {
                const container = document.getElementById('geneButtons');
                if (!container) return;
                container.innerHTML = '';
                genesToDisplay.forEach(gene => {
                    const isSearch = searchResults.some(s => s.gene === gene.gene);
                    const button = document.createElement('button');
                    button.className = `gene-btn ${isSearch ? 'search-gene' : 'default'}`;
                    button.textContent = gene.gene;
                    button.onclick = () => showLocalization(gene.gene, isSearch);
                    container.appendChild(button);
                });
                const resetButton = document.createElement('button');
                resetButton.className = 'gene-btn reset-btn';
                resetButton.textContent = 'Reset Diagram';
                resetButton.onclick = () => showLocalization('reset');
                container.appendChild(resetButton);
            }

            function showLocalization(geneName, isSearchGene) {
                const ciliaParts = ciliaPanel.querySelectorAll('.cilia-part');
                ciliaParts.forEach(part => part.classList.remove('highlighted', 'search-gene'));
                if (geneName !== 'reset' && geneLocalizationData[geneName]) {
                    geneLocalizationData[geneName].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.classList.add('highlighted');
                            if (isSearchGene) el.classList.add('search-gene');
                        }
                    });
                }
            }

            function updateActiveNav(path) {
                document.querySelectorAll('.nav-links a').forEach(link => {
                    link.classList.remove('active');
                    const linkPath = link.getAttribute('href');
                    if (linkPath === path || (path.startsWith('/') && path !== '/' && linkPath === '/batch-query')) {
                         link.classList.add('active');
                    }
                });
            }

            // --- Navigation Event Handling ---
            window.navigateTo = function(event, path) {
                if (event) event.preventDefault();
                window.history.pushState({}, '', path);
                handleRouteChange();
            }

            window.addEventListener('popstate', handleRouteChange);
            handleRouteChange(); // Initial load
        });
    </script>
</body>
</html>
