<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The CiliaHub: A Database of Genes with Ciliary Functions</title>
    <meta name="description" content="The CiliaHub is a comprehensive bioinformatics database for genes with ciliary functions, providing resources for ciliopathy research, genome exploration, and gene search.">
    <meta name="keywords" content="cilia gene, ciliopathy, database, search, genome, bioinformatics, ciliary function, ciliary genes">
    <link rel="icon" type="image/png" href="CiliaHub_Logo_web.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8fafc; color: #2c3e50; line-height: 1.6; }
        .main-container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; display: grid; grid-template-columns: 1fr 350px; gap: 2rem; align-items: start; }
        .content-area { display: flex; flex-direction: column; gap: 1.5rem; }
        .content-area-full { grid-column: 1 / -1; }
        .navbar { background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%); padding: 1rem 0; box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 2rem; font-weight: bold; color: #ffffff; text-decoration: none; transition: transform 0.3s ease; margin-right: 2rem; }
        .logo:hover { transform: scale(1.05); }
        .nav-links { display: flex; list-style: none; gap: 1.5rem; flex-wrap: wrap; }
        .nav-links a { 
            color: #e8f4fd; 
            text-decoration: none; 
            padding: 0.8rem 1.5rem; 
            border-radius: 25px; 
            transition: all 0.3s ease; 
            font-weight: 600; 
            background: rgba(255, 255, 255, 0.1); 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); 
            min-width: 120px; 
            text-align: center; 
        }
        .nav-links a:hover, .nav-links a.active { 
            background: #ffffff; 
            color: #2c5aa0; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.4); 
        }
        .page-section { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1); }
        .search-container { display: flex; gap: 1rem; margin-top: 1rem; }
        #single-gene-search, #batch-genes-input { padding: 1rem; border: 2px solid #e1ecf4; border-radius: 10px; font-size: 1rem; }
        #single-gene-search { flex: 1; width: 100%; }
        #batch-genes-input { width: 100%; min-height: 100px; resize: vertical; margin-top: 1rem; margin-bottom: 1rem; }
        .search-btn { padding: 1rem 2rem; background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .search-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(44, 90, 160, 0.3); }
        .search-wrapper { position: relative; }
        #search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 10px 10px;
            z-index: 999;
            max-height: 250px;
            overflow-y: auto;
        }
        #search-suggestions ul { list-style: none; padding: 0; margin: 0; }
        #search-suggestions li { padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid #eee; }
        #search-suggestions li:last-child { border-bottom: none; }
        #search-suggestions li:hover, #search-suggestions li.active { background-color: #f0f5fa; color: #2c5aa0; }
        .gene-cards { display: grid; gap: 1.5rem; }
        .gene-card { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1); transition: all 0.3s ease; border-left: 5px solid transparent; cursor: pointer; }
        .gene-card:hover { transform: translateY(-5px); }
        .gene-card.default { border-left-color: #1e90ff; }
        .gene-card.search-result { border-left-color: #27ae60; }
        .gene-name { font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem; }
        .gene-card.default .gene-name { color: #1e90ff; }
        .gene-card.search-result .gene-name { color: #27ae60; }
        .gene-description { color: #7f8c8d; font-size: 0.95rem; }
        .gene-info { font-size: 0.9rem; color: #34495e; margin-bottom: 0.5rem; }
        .gene-info a { color: #2c5aa0; text-decoration: none; }
        .gene-info a:hover { text-decoration: underline; }
        .gene-btn.selected { background: #2c5aa0; color: white; border-color: #2c5aa0; }
        .cilia-panel { background: white; border-radius: 15px; box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1); position: sticky; top: 100px; height: fit-content; }
        .panel-header { background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%); color: white; padding: 1.5rem; text-align: center; }
        .panel-content { padding: 1.5rem; }
        .cilia-container { text-align: center; margin-bottom: 1.5rem; }
        .interactive-cilium svg { width: 100%; height: 400px; }
        .cilia-part { stroke: #2c3e50; stroke-width: 1.5; transition: all 0.3s ease-in-out; cursor: pointer; }
        .cilia-part:hover { stroke-width: 3; filter: brightness(1.1); }
        .highlighted { fill: #1e90ff !important; opacity: 0.9 !important; animation: pulse 2s infinite; }
        .highlighted.search-gene { fill: #27ae60 !important; }
        .highlighted.cilia { fill: #006400 !important; opacity: 0.9 !important; }
        @keyframes pulse { 0%, 100% { opacity: 0.9; } 50% { opacity: 0.6; } }
        .controls { background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-top: 1rem; }
        .gene-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
        .gene-btn { padding: 0.7rem; border: 1px solid #e1ecf4; border-radius: 8px; background: white; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        .gene-btn.default { color: #1e90ff; }
        .gene-btn.search-gene { background: #27ae60; color: white; border-color: #27ae60; }
        .gene-btn:hover { background: #2c5aa0; color: white; transform: translateX(3px); }
        .gene-btn.search-gene:hover { background: #219a52; }
        .reset-btn { background: #95a5a6 !important; color: white !important; margin-top: 0.5rem; }
        .reset-btn:hover { background: #7f8c8d !important; }
        .download-options, .contact-info, .cite-list { margin-top: 1rem; }
        .download-options a { display: inline-block; padding: 0.8rem 1.5rem; background: #2c5aa0; color: white; text-decoration: none; border-radius: 8px; margin-right: 1rem; margin-bottom: 1rem; }
        .download-options a:hover { background: #1e3a5f; transform: translateY(-2px); }
        .contact-info, .cite-list { background: #f8f9fa; padding: 1.5rem; border-radius: 10px; }
        .contact-info h3, .cite-list h3 { margin-bottom: 1rem; color: #2c3e50; }
        .contact-info li, .cite-list li { margin-bottom: 0.8rem; font-size: 1rem; }
        .contact-info a { color: #2c5aa0; text-decoration: none; }
        .contact-info a:hover { text-decoration: underline; }
        .feedback-form { margin-top: 2rem; }
        .feedback-form textarea { width: 100%; min-height: 150px; padding: 1rem; border: 2px solid #e1ecf4; border-radius: 10px; font-size: 1rem; margin-top: 0.5rem; }
        .status-message { text-align: center; padding: 3rem; color: #7f8c8d; font-style: italic; }
        .error-message { color: #e74c3c; font-weight: bold; }
        .success-message { color: #27ae60; font-weight: bold; }
        .gene-detail-page { cursor: default; }
        .gene-detail-page h1 { font-size: 2.5rem; margin-top: 1rem; color: #27ae60; }
        .gene-detail-page .gene-description { font-size: 1.1rem; }
        .breadcrumb a { color: #2c5aa0; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        @media (max-width: 992px) {
            .main-container { grid-template-columns: 1fr; }
            .cilia-panel { position: relative; top: auto; }
            .nav-container { flex-direction: column; gap: 1rem; align-items: flex-start; }
            .nav-links { gap: 1rem; justify-content: flex-start; }
            .nav-links a { min-width: 100px; }
        }
        .search-container.sticky {
            position: sticky;
            top: 80px;
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.1);
            z-index: 500;
        }
        .pagination { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; }
        .pagination button { padding: 0.5rem 1rem; background: #2c5aa0; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .pagination button:disabled { background: #95a5a6; cursor: not-allowed; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip-icon { background: #2c5aa0; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; }
        .tooltip-text { visibility: hidden; position: absolute; background: #fff; border: 1px solid #ddd; padding: 1rem; border-radius: 8px; width: 200px; z-index: 10; }
        .tooltip:hover .tooltip-text { visibility: visible; }
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 90, 160, 0.3);
        }
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        .search-btn, .gene-btn, .reset-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            color: white;
        }
        .reset-btn {
            background: #95a5a6 !important;
            color: white !important;
        }
        .reset-btn:hover {
            background: #7f8c8d !important;
        }
        .gene-btn.default { background: white; color: #1e90ff; border: 1px solid #e1ecf4; }
        .gene-btn.search-gene { background: #27ae60; color: white; border-color: #27ae60; }
        .gene-btn:hover { background: #2c5aa0; color: white; transform: translateX(3px); }
        .gene-btn.search-gene:hover { background: #219a52; }
        #comparison-table th, #comparison-table td { border: 1px solid #ddd; padding: 0.5rem; text-align: left; }
        #comparison-table th { background: #2c5aa0; color: white; }
        #comparison-table a { color: #2c5aa0; text-decoration: none; }
        #comparison-table a:hover { text-decoration: underline; }
        
        /* Enhanced Compare Section Styles */
        .multi-select-container {
            position: relative;
            width: 100%;
            margin-bottom: 1.5rem;
        }
        
        .multi-select-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1ecf4;
            border-radius: 10px;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 10px 10px;
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .multi-select-dropdown.active {
            display: block;
        }
        
        .multi-select-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .multi-select-option:hover {
            background-color: #f0f5fa;
        }
        
        .multi-select-option input {
            margin-right: 10px;
        }
        
        .selected-genes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .selected-gene-pill {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .selected-gene-pill .remove-btn {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
        }
        
        .comparison-view {
            display: grid;
            grid-template-columns: 200px repeat(auto-fit, minmax(250px, 1fr));
            gap: 1px;
            background-color: #e1ecf4;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .comparison-header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .comparison-cell {
            background: white;
            padding: 12px 15px;
        }
        
        .comparison-row-header {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .visual-comparison {
            margin-top: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(44, 90, 160, 0.1);
            margin-bottom: 20px;
        }
        
        .filter-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background: white;
            border: 1px solid #e1ecf4;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .filter-btn.active {
            background: #2c5aa0;
            color: white;
            border-color: #2c5aa0;
        }
        
        .export-options {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .comparison-view {
                grid-template-columns: 150px repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .comparison-cell {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .filter-options {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" onclick="navigateTo(event, '/')" class="logo" aria-label="CiliaHub Home">CiliaHub</a>
            <ul class="nav-links">
                <li><a href="/" onclick="navigateTo(event, '/')" aria-label="Home">Home</a></li>
                <li><a href="/batch-query" onclick="navigateTo(event, '/batch-query')" aria-label="Batch Query">Batch Query</a></li>
                <li><a href="/compare" onclick="navigateTo(event, '/compare')" aria-label="Compare" class="active">Compare</a></li>
                <li><a href="/download" onclick="navigateTo(event, '/download')" aria-label="Download">Download</a></li>
                <li><a href="/contact" onclick="navigateTo(event, '/contact')" aria-label="Contact">Contact & Cite</a></li>
            </ul>
        </div>
    </nav>
    <div class="main-container">
        <div class="content-area content-area-full">
            <div class="page-section">
                <h2>Compare Genes</h2>
                <p>Select multiple genes to compare their properties, localization, and functions side by side.</p>
                
                <div class="multi-select-container">
                    <div class="multi-select-input" id="gene-select-trigger">
                        <span>Select genes to compare...</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="multi-select-dropdown" id="gene-select-dropdown">
                        <!-- Options will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="selected-genes-container" id="selected-genes-container">
                    <!-- Selected genes will appear here as pills -->
                </div>
                
                <div class="filter-options">
                    <div class="filter-btn active" data-filter="all">All Properties</div>
                    <div class="filter-btn" data-filter="basic">Basic Info</div>
                    <div class="filter-btn" data-filter="localization">Localization</div>
                    <div class="filter-btn" data-filter="functional">Functional Data</div>
                    <div class="filter-btn" data-filter="clinical">Clinical Associations</div>
                </div>
                
                <button id="compare-btn" class="search-btn btn btn-primary">Compare Selected Genes</button>
                
                <div id="comparison-results">
                    <!-- Comparison results will be displayed here -->
                </div>
                
                <div class="visual-comparison" id="visual-comparison">
                    <!-- Visual comparison charts will be added here -->
                </div>
                
                <div class="export-options">
                    <button id="export-csv" class="btn btn-secondary">Export as CSV</button>
                    <button id="export-png" class="btn btn-secondary">Export Chart as PNG</button>
                </div>
            </div>
        </div>
        <aside class="cilia-panel">
            <div class="panel-header">
                <h3>Interactive Cilium</h3>
                <p style="font-size: 0.9rem; opacity: 0.9;">Click genes to see localization</p>
            </div>
            <div class="panel-content">
                <div class="cilia-container interactive-cilium">
                    <svg viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                        <path id="cell-body" class="cilia-part" tabindex="0" fill="none" d="M 50,380 C -20,300 20,200 150,200 C 280,200 320,300 250,380 Z" aria-label="Cell Body"/>
                        <circle id="nucleus" class="cilia-part" tabindex="0" fill="#A7C7E7" cx="150" cy="320" r="40" aria-label="Nucleus"/>
                        <rect id="basal-body" class="cilia-part" tabindex="0" fill="#2F2F2F" x="140" y="195" width="20" height="15" aria-label="Basal Body"/>
                        <path id="transition-zone" class="cilia-part" tabindex="0" fill="#9B59B6" d="M 142,195 L 138,180 L 162,180 L 158,195 Z" aria-label="Transition Zone"/>
                        <path id="ciliary-membrane" class="cilia-part" tabindex="0" fill="none" fill-opacity="0.5" d="M 138,180 L 145,10 L 155,10 L 162,180 Z" aria-label="Ciliary Membrane"/>
                        <path id="axoneme" class="cilia-part" tabindex="0" fill="none" d="M 145,180 L 148,15 L 152,15 L 155,180 Z" aria-label="Axoneme"/>
                    </svg>
                </div>
                <div class="controls">
                    <h4>Gene Localization:</h4>
                    <div id="geneButtons" class="gene-buttons"></div>
                </div>
            </div>
        </aside>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables for data management
        const geneLocalizationData = {};
        let allGenes = [];
        let currentData = [];
        let searchResults = [];
        const allPartIds = ["cell-body", "nucleus", "basal-body", "transition-zone", "axoneme", "ciliary-membrane"];
        const defaultGenesNames = ["ACE2", "ADAMTS20", "ADAMTS9", "IFT88", "CEP290", "WDR31", "ARL13B", "BBS1"];
        let selectedGenes = [];

        // Sample gene data
        const sampleGenes = [
            {
                gene: "IFT88",
                description: "Intraflagellar transport protein 88. Key component of the IFT-B complex.",
                localization: "Axoneme, Basal Body",
                ensembl_id: "ENSG00000032742",
                functional_summary: "Essential for intraflagellar transport and ciliary assembly.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2752273/"
            },
            {
                gene: "CEP290",
                description: "Centrosomal protein 290. Critical component of the ciliary transition zone.",
                localization: "Transition Zone",
                ensembl_id: "ENSG00000198707",
                omim_id: "610142",
                functional_summary: "Regulates ciliary gating and ciliopathy-related pathways.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2836202/"
            },
            {
                gene: "WDR31",
                description: "WD repeat domain 31. Involved in ciliary assembly and maintenance.",
                localization: "Axoneme",
                ensembl_id: "ENSG00000106459",
                functional_summary: "Required for proper ciliary structure and function.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5890658/"
            },
            {
                gene: "ARL13B",
                description: "ADP-ribosylation factor-like protein 13B. Involved in ciliary membrane biogenesis.",
                localization: "Ciliary Membrane",
                ensembl_id: "ENSG00000169379",
                functional_summary: "Critical for ciliary signaling and membrane trafficking.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3554441/"
            },
            {
                gene: "BBS1",
                description: "Bardet-Biedl syndrome 1 protein. Part of the BBSome complex.",
                localization: "Basal Body, Ciliary Membrane",
                ensembl_id: "ENSG00000166246",
                omim_id: "209901",
                functional_summary: "Involved in ciliary trafficking and BBSome assembly.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2836202/"
            },
            {
                gene: "ACE2",
                description: "Angiotensin-converting enzyme 2. Serves as the entry point for SARS-CoV-2.",
                localization: "Cilia",
                ensembl_id: "ENSG00000130234",
                omim_id: "300335",
                functional_summary: "Regulates blood pressure and acts as receptor for coronaviruses in respiratory cilia.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7467118/"
            },
            {
                gene: "ADAMTS20",
                description: "ADAM metallopeptidase with thrombospondin type 1 motif 20.",
                localization: "Cilia, Extracellular Matrix",
                ensembl_id: "ENSG00000162772",
                functional_summary: "Involved in extracellular matrix organization and ciliary function.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6742600/"
            },
            {
                gene: "ADAMTS9",
                description: "ADAM metallopeptidase with thrombospondin type 1 motif 9.",
                localization: "Cilia, Extracellular Matrix",
                ensembl_id: "ENSG00000163635",
                functional_summary: "Essential for ciliary development and extracellular matrix remodeling.",
                reference: "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6742600/"
            }
        ];

        // Load data from external JSON file or use sample data
        async function loadGeneDatabase() {
            try {
                // Try to load from external source
                const response = await fetch('https://raw.githubusercontent.com/theCiliaHub/theCiliaHub.github.io/main/ciliahub_data.json');
                allGenes = await response.json();
            } catch (error) {
                console.error('Error loading gene database:', error);
                // Fallback to sample data if loading fails
                allGenes = [...sampleGenes];
            }
            
            // Initialize gene localization data
            allGenes.forEach(gene => {
                if (gene.localization && gene.gene) {
                    geneLocalizationData[gene.gene] = mapLocalizationToSVG(gene.localization);
                }
            });
            
            // Set current data to default genes
            currentData = allGenes.filter(g => defaultGenesNames.includes(g.gene));
            
            console.log('Data loaded successfully:', allGenes.length, 'entries');
            return true;
        }

        function mapLocalizationToSVG(localization) {
            const mapping = {
                "ciliary membrane": ["ciliary-membrane", "axoneme"],
                "axoneme": ["ciliary-membrane", "axoneme"],
                "basal body": ["basal-body"],
                "transition zone": ["transition-zone"],
                "cilia": ["ciliary-membrane", "axoneme"],
                "flagella": ["ciliary-membrane", "axoneme"],
                "ciliary associated gene": ["ciliary-membrane", "axoneme"],
                "extracellular matrix": ["cell-body"]
            };
            
            if (!localization) return [];
            
            return localization.split(',')
                .flatMap(loc => {
                    const trimmedLoc = loc.trim().toLowerCase();
                    return mapping[trimmedLoc] || [];
                })
                .filter(id => allPartIds.includes(id));
        }

        // Enhanced Compare Page Functionality
        function displayComparePage() {
            const contentArea = document.querySelector('.content-area');
            contentArea.className = 'content-area content-area-full';
            document.querySelector('.cilia-panel').style.display = 'none';
            
            contentArea.innerHTML = `
                <div class="page-section">
                    <h2>Compare Genes</h2>
                    <p>Select multiple genes to compare their properties, localization, and functions side by side.</p>
                    
                    <div class="multi-select-container">
                        <div class="multi-select-input" id="gene-select-trigger">
                            <span>Select genes to compare...</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="multi-select-dropdown" id="gene-select-dropdown">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="selected-genes-container" id="selected-genes-container">
                        <!-- Selected genes will appear here as pills -->
                    </div>
                    
                    <div class="filter-options">
                        <div class="filter-btn active" data-filter="all">All Properties</div>
                        <div class="filter-btn" data-filter="basic">Basic Info</div>
                        <div class="filter-btn" data-filter="localization">Localization</div>
                        <div class="filter-btn" data-filter="functional">Functional Data</div>
                        <div class="filter-btn" data-filter="clinical">Clinical Associations</div>
                    </div>
                    
                    <button id="compare-btn" class="search-btn btn btn-primary">Compare Selected Genes</button>
                    
                    <div id="comparison-results">
                        <!-- Comparison results will be displayed here -->
                    </div>
                    
                    <div class="visual-comparison" id="visual-comparison">
                        <!-- Visual comparison charts will be added here -->
                    </div>
                    
                    <div class="export-options">
                        <button id="export-csv" class="btn btn-secondary">Export as CSV</button>
                        <button id="export-png" class="btn btn-secondary">Export Chart as PNG</button>
                    </div>
                </div>`;
            
            // Initialize the multi-select component
            initMultiSelect();
            
            // Set up event listeners
            document.getElementById('compare-btn').addEventListener('click', performMultiGeneComparison);
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterComparisonTable(this.dataset.filter);
                });
            });
            
            document.getElementById('export-csv').addEventListener('click', exportComparisonCSV);
            document.getElementById('export-png').addEventListener('click', exportChartsAsPNG);
        }
        
        function initMultiSelect() {
            const trigger = document.getElementById('gene-select-trigger');
            const dropdown = document.getElementById('gene-select-dropdown');
            
            // Populate dropdown with gene options
            const optionsHtml = allGenes.map(gene => `
                <div class="multi-select-option" data-gene="${gene.gene}">
                    <input type="checkbox" id="gene-${gene.gene}" data-gene="${gene.gene}">
                    <label for="gene-${gene.gene}">${gene.gene}${gene.synonym ? ` (${gene.synonym})` : ''}</label>
                </div>
            `).join('');
            
            dropdown.innerHTML = optionsHtml;
            
            // Toggle dropdown visibility
            trigger.addEventListener('click', function() {
                dropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                if (!trigger.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('active');
                }
            });
            
            // Handle gene selection
            dropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const gene = this.dataset.gene;
                    
                    if (this.checked) {
                        if (!selectedGenes.includes(gene)) {
                            selectedGenes.push(gene);
                        }
                    } else {
                        selectedGenes = selectedGenes.filter(g => g !== gene);
                    }
                    
                    updateSelectedGenesDisplay();
                });
            });
        }
        
        function updateSelectedGenesDisplay() {
            const container = document.getElementById('selected-genes-container');
            
            if (selectedGenes.length === 0) {
                container.innerHTML = '<p>No genes selected. Select genes from the dropdown above.</p>';
                return;
            }
            
            container.innerHTML = selectedGenes.map(gene => `
                <div class="selected-gene-pill">
                    ${gene}
                    <button class="remove-btn" data-gene="${gene}">&times;</button>
                </div>
            `).join('');
            
            // Add event listeners to remove buttons
            container.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const geneToRemove = this.dataset.gene;
                    selectedGenes = selectedGenes.filter(g => g !== geneToRemove);
                    
                    // Also uncheck the checkbox in the dropdown
                    const checkbox = document.getElementById(`gene-${geneToRemove}`);
                    if (checkbox) checkbox.checked = false;
                    
                    updateSelectedGenesDisplay();
                });
            });
        }
        
        function performMultiGeneComparison() {
            if (selectedGenes.length < 2) {
                alert('Please select at least two genes to compare.');
                return;
            }
            
            const genesData = selectedGenes.map(geneName => 
                allGenes.find(g => g.gene === geneName)
            ).filter(Boolean);
            
            if (genesData.length !== selectedGenes.length) {
                alert('Some selected genes were not found in the database.');
                return;
            }
            
            displayComparisonTable(genesData);
            createVisualComparisons(genesData);
        }
        
        function displayComparisonTable(genesData) {
            const comparisonProperties = [
                { key: 'gene', label: 'Gene Symbol' },
                { key: 'synonym', label: 'Synonym' },
                { key: 'description', label: 'Description' },
                { key: 'ensembl_id', label: 'Ensembl ID' },
                { key: 'omim_id', label: 'OMIM ID' },
                { key: 'localization', label: 'Localization' },
                { key: 'functional_summary', label: 'Functional Summary' },
                { key: 'reference', label: 'Reference' }
            ];
            
            let tableHtml = `
                <div class="comparison-view">
                    <div class="comparison-header">Property</div>
            `;
            
            // Add gene headers
            genesData.forEach(gene => {
                tableHtml += `<div class="comparison-header">${gene.gene}</div>`;
            });
            
            // Add rows for each property
            comparisonProperties.forEach(prop => {
                tableHtml += `
                    <div class="comparison-cell comparison-row-header">${prop.label}</div>
                `;
                
                genesData.forEach(gene => {
                    let value = gene[prop.key] || '-';
                    // Create links for IDs
                    if (prop.key === 'ensembl_id' && value !== '-') {
                        value = `<a href="https://www.ensembl.org/Homo_sapiens/Gene/Summary?g=${value}" target="_blank">${value}</a>`;
                    } else if (prop.key === 'omim_id' && value !== '-') {
                        value = `<a href="https://www.omim.org/entry/${value}" target="_blank">${value}</a>`;
                    } else if (prop.key === 'reference' && value !== '-') {
                        value = `<a href="${value}" target="_blank">View Reference</a>`;
                    }
                    
                    tableHtml += `
                        <div class="comparison-cell" data-property="${prop.key}">${value}</div>
                    `;
                });
            });
            
            tableHtml += `</div>`;
            
            document.getElementById('comparison-results').innerHTML = tableHtml;
        }
        
        function filterComparisonTable(filterType) {
            const allCells = document.querySelectorAll('.comparison-cell');
            const rowHeaders = document.querySelectorAll('.comparison-row-header');
            
            // First, show all cells
            allCells.forEach(cell => cell.style.display = '');
            rowHeaders.forEach(header => header.style.display = '');
            
            if (filterType === 'all') return;
            
            // Define which properties belong to which category
            const propertyCategories = {
                'basic': ['gene', 'synonym', 'description', 'ensembl_id', 'omim_id'],
                'localization': ['localization'],
                'functional': ['functional_summary'],
                'clinical': ['reference']
            };
            
            const propertiesToShow = propertyCategories[filterType] || [];
            
            // Hide cells that don't belong to the selected category
            allCells.forEach(cell => {
                const property = cell.dataset.property;
                if (property && !propertiesToShow.includes(property)) {
                    cell.style.display = 'none';
                }
            });
            
            // Hide row headers for hidden rows
            rowHeaders.forEach(header => {
                const property = header.textContent.toLowerCase().replace(' ', '_');
                if (!propertiesToShow.includes(property)) {
                    header.style.display = 'none';
                }
            });
        }
        
        function createVisualComparisons(genesData) {
            const container = document.getElementById('visual-comparison');
            container.innerHTML = '';
            
            // Create localization comparison chart
            const localizationChartHtml = `
                <div class="chart-container">
                    <h3>Localization Comparison</h3>
                    <canvas id="localization-chart" width="400" height="200"></canvas>
                </div>
            `;
            
            container.innerHTML += localizationChartHtml;
            
            // Process localization data for charting
            const allLocalizations = new Set();
            genesData.forEach(gene => {
                if (gene.localization) {
                    const locations = gene.localization.split(',').map(loc => loc.trim());
                    locations.forEach(loc => allLocalizations.add(loc));
                }
            });
            
            const localizationArray = Array.from(allLocalizations);
            const datasets = localizationArray.map(loc => {
                return {
                    label: loc,
                    data: genesData.map(gene => {
                        if (!gene.localization) return 0;
                        const geneLocations = gene.localization.split(',').map(l => l.trim());
                        return geneLocations.includes(loc) ? 1 : 0;
                    }),
                    backgroundColor: getColorForLocalization(loc)
                };
            });
            
            // Create the chart
            const ctx = document.getElementById('localization-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: genesData.map(g => g.gene),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Gene Localization Comparison'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + (context.raw === 1 ? 'Yes' : 'No');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function getColorForLocalization(localization) {
            const colorMap = {
                'Axoneme': '#FF6384',
                'Basal Body': '#36A2EB',
                'Transition Zone': '#FFCE56',
                'Ciliary Membrane': '#4BC0C0',
                'Cilia': '#9966FF',
                'Extracellular Matrix': '#FF9F40'
            };
            
            return colorMap[localization] || '#' + Math.floor(Math.random()*16777215).toString(16);
        }
        
        function exportComparisonCSV() {
            if (selectedGenes.length === 0) {
                alert('No genes selected for export.');
                return;
            }
            
            const genesData = selectedGenes.map(geneName => 
                allGenes.find(g => g.gene === geneName)
            ).filter(Boolean);
            
            const comparisonProperties = [
                { key: 'gene', label: 'Gene Symbol' },
                { key: 'synonym', label: 'Synonym' },
                { key: 'description', label: 'Description' },
                { key: 'ensembl_id', label: 'Ensembl ID' },
                { key: 'omim_id', label: 'OMIM ID' },
                { key: 'localization', label: 'Localization' },
                { key: 'functional_summary', label: 'Functional Summary' },
                { key: 'reference', label: 'Reference' }
            ];
            
            // Create CSV header
            let csv = 'Property,' + genesData.map(g => g.gene).join(',') + '\n';
            
            // Add data rows
            comparisonProperties.forEach(prop => {
                const row = [prop.label];
                genesData.forEach(gene => {
                    let value = gene[prop.key] || '';
                    // Remove HTML tags and escape quotes
                    value = value.replace(/(<([^>]+)>)/gi, "").replace(/"/g, '""');
                    row.push(`"${value}"`);
                });
                csv += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ciliahub_comparison.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function exportChartsAsPNG() {
            // This would need a more complex implementation using a library like html2canvas
            alert('Chart export functionality would be implemented with a library like html2canvas in a production environment.');
        }

        // Initialize the application
        async function initApp() {
            await loadGeneDatabase();
            displayComparePage();
        }

        // Start the application
        initApp();
    </script>
</body>
</html>
