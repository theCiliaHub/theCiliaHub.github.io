<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CiliaHub – Gene Expression</title>
  <link rel="icon" type="image/png" href="CiliaHub_Logo_web.png">
  <style>
    /* General Styles & Layout */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #2c3e50;
      line-height: 1.6;
    }
    .main-container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    /* Navbar */
    .navbar {
      background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
      padding: 1rem 0;
      box-shadow: 0 4px 15px rgba(44, 90, 160, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 2rem;
      font-weight: bold;
      color: #ffffff;
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      list-style: none;
      gap: 2rem;
    }
    .nav-links a {
      color: #e8f4fd;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .nav-links a:hover,
    .nav-links a.active {
      background-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    /* Header */
    header {
      background-color: #3373C4;
      padding: 2rem;
      text-align: center;
      color: #ffffff;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1);
      margin-bottom: 1.5rem;
    }
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    /* Main Content Grid */
    .grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1.5rem;
    }
    .page-section {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1);
    }
    /* Search Bar */
    .search {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      position: relative;
    }
    .search input {
      flex: 1;
      padding: 1rem;
      border: 2px solid #e1ecf4;
      border-radius: 10px;
      font-size: 1rem;
      outline: none;
    }
    .search input:focus {
      border-color: #2c5aa0;
    }
    .search button {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    .search button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(44, 90, 160, 0.3);
    }
    .search button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1);
      display: none;
      z-index: 10;
      max-height: 200px;
      overflow-y: auto;
    }
    .suggestion {
      padding: 0.7rem 1rem;
      cursor: pointer;
      color: #2c3e50;
    }
    .suggestion:hover {
      background-color: #f8f9fa;
    }
    /* Table */
    .table-wrap {
      margin-top: 1.5rem;
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }
    thead {
      background-color: #f8f9fa;
    }
    th, td {
      padding: 0.7rem;
      text-align: left;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:hover {
      background-color: #f0f0f0;
    }
    /* Legend */
    .legend {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      margin-top: 1.5rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #2c3e50;
    }
    .sw {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    /* SVG */
    .viz {
      position: relative;
      width: 100%;
      height: 500px;
      margin-top: 1.5rem;
    }
    #svgHost {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }
    .tooltip {
      position: absolute;
      background-color: rgba(44, 62, 80, 0.8);
      color: #ffffff;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.9rem;
      display: none;
      pointer-events: none;
    }
    .organ {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .organ:hover {
      filter: brightness(1.2);
    }
    .muted {
      color: #7f8c8d;
    }
    /* Footer */
    footer {
      text-align: center;
      padding: 2rem 0;
      color: #7f8c8d;
      font-size: 0.9rem;
      margin-top: 2rem;
    }
    /* Status Messages */
    .status-message {
      text-align: center;
      padding: 2rem;
      color: #7f8c8d;
      font-style: italic;
    }
    .error-message {
      color: #e74c3c;
      font-weight: bold;
    }
    /* Responsive Design */
    @media (max-width: 992px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      .grid {
        grid-template-columns: 1fr;
      }
      .nav-container {
        flex-direction: column;
        gap: 1rem;
      }
      .nav-links {
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="/" onclick="navigateTo(event, '/')" class="logo" aria-label="CiliaHub Home">CiliaHub</a>
      <ul class="nav-links">
        <li><a href="/" onclick="navigateTo(event, '/')" aria-label="Home">Home</a></li>
        <li><a href="/batch-query" onclick="navigateTo(event, '/batch-query')" aria-label="Batch Query">Batch Query</a></li>
        <li><a href="/expression" onclick="navigateTo(event, '/expression')" class="active" aria-label="Expression">Expression</a></li>
        <li><a href="/download" onclick="navigateTo(event, '/download')" aria-label="Download">Download</a></li>
        <li><a href="/cite" onclick="navigateTo(event, '/cite')" aria-label="Cite">Cite</a></li>
        <li><a href="/contact" onclick="navigateTo(event, '/contact')" aria-label="Contact">Contact</a></li>
      </ul>
    </div>
  </nav>

  <div class="main-container">
    <div class="grid">
      <div class="page-section">
        <header>
          <h1>Gene Expression Visualization</h1>
          <p>Explore the RNA expression of genes across various tissues and organs.</p>
        </header>
        <div class="search">
          <input id="geneInput" type="text" placeholder="Search Gene (e.g., ARL13B)" aria-label="Search for a gene" autocomplete="off" />
          <button id="searchBtn" class="search-btn" aria-label="Search">Search</button>
          <div id="suggestions"></div>
        </div>
        <div id="status" class="muted status-message">Enter a gene symbol to begin.</div>
        <div class="legend">
          <div class="legend-item"><span class="sw" style="background: #C8E6C9;"></span> Low (0–5 nTPM)</div>
          <div class="legend-item"><span class="sw" style="background: #81C784;"></span> Medium (5–15 nTPM)</div>
          <div class="legend-item"><span class="sw" style="background: #4CAF50;"></span> High (15–30 nTPM)</div>
          <div class="legend-item"><span class="sw" style="background: #2E7D32;"></span> Very High (>30 nTPM)</div>
        </div>
        <div id="tableWrap" class="table-wrap">
          <table id="exprTable">
            <thead><tr><th>Tissue/Organ</th><th>nTPM</th><th>Expression Level</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="page-section viz">
        <div id="svgHost"></div>
        <div id="tooltip" class="tooltip"></div>
      </div>
    </div>
  </div>

  <footer>
    <p>© 2025 CiliaHub. All rights reserved.</p>
  </footer>

  <script>
    const SVG_URL = "assets/file.svg";
    const CURATED_URL = "curated_genes.json";
    const BULK_JSON_URL = "rna_tissue_consensus.json";
    const PER_GENE_DIR = "genes";

    const TISSUE_TO_SVG_IDS = {
      "adipose tissue": ["path-adipose"],
      "adrenal gland": ["path-adrenal-gland-left","path-adrenal-gland-right"],
      "bone marrow": ["path-bone-marrow"],
      "brain": ["path-brain","path-cerebellum"],
      "cerebellum": ["path-cerebellum"],
      "cervix, uterine": ["path-cervix"],
      "colon": ["path-colon"],
      "endometrium": ["path-endometrium"],
      "epididymis": ["path-epididymis-left","path-epididymis-right"],
      "esophagus": ["path-esophagus"],
      "fallopian tube": ["path-fallopian-tube-left","path-fallopian-tube-right"],
      "gallbladder": ["path-gall-bladder"],
      "heart muscle": ["path-heart"],
      "kidney": ["path-kidney-left","path-kidney-right"],
      "liver": ["path-liver"],
      "lung": ["path-lung-left","path-lung-right"],
      "ovary": ["path-ovary-left","path-ovary-right"],
      "pancreas": ["path-pancreas"],
      "placenta": ["path-placenta"],
      "prostate": ["path-prostate"],
      "seminal vesicle": ["path-seminal-vesicle"],
      "skeletal muscle": ["path-muscle"],
      "skin": ["path-skin"],
      "small intestine": ["path-small-intestine"],
      "smooth muscle": ["path-smooth-muscle"],
      "spleen": ["path-spleen"],
      "stomach": ["path-stomach"],
      "testis": ["path-testis-left","path-testis-right"],
      "thyroid gland": ["path-thyroid"],
      "trachea": ["path-trachea"]
    };

    let curatedGenes = [];
    let svgRoot = null;
    let organs = [];
    let currentGene = null;
    let svgLoaded = false;
    const tooltip = document.getElementById('tooltip');

    const byId = (id) => document.getElementById(id);
    const status = byId('status');
    const tableWrap = byId('tableWrap');
    const tbody = document.querySelector('#exprTable tbody');

    function ntpmToLevel(n) {
      if (n <= 5) return 'Low';
      if (n <= 15) return 'Medium';
      if (n <= 30) return 'High';
      return 'Very High';
    }

    function ntpmToColor(n) {
      if (n <= 5) return '#C8E6C9';
      if (n <= 15) return '#81C784';
      if (n <= 30) return '#4CAF50';
      return '#2E7D32';
    }

    function resetOrgans() {
      if (!organs.length) return;
      organs.forEach(o => {
        o.style.fill = '#E0E0E0';
        o.removeAttribute('data-tissue');
        o.removeAttribute('data-ntpm');
        o.removeAttribute('data-level');
      });
      tooltip.style.display = 'none';
    }

    function titleCaseTissue(t) {
      return t.replace(/_/g, ' ').replace(/,/g, '').replace(/\b\w/g, c => c.toUpperCase());
    }

    function debounce(fn, delay = 120) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      };
    }

    async function loadSVG() {
      try {
        byId('svgHost').innerHTML = '';
        const resp = await fetch(SVG_URL);
        if (!resp.ok) throw new Error(`Failed to load SVG: ${resp.status} ${resp.statusText}`);
        const svgText = await resp.text();
        byId('svgHost').innerHTML = svgText;
        svgRoot = byId('svgHost').querySelector('svg');
        if (!svgRoot) throw new Error('SVG element not found after loading');
        await new Promise(resolve => setTimeout(resolve, 50));
        organs = svgRoot.querySelectorAll('.organ');
        if (organs.length === 0) console.warn('No .organ elements found in SVG');
        resetOrgans();
        organs.forEach(o => {
          o.addEventListener('mousemove', (e) => {
            const tissue = o.getAttribute('data-tissue');
            const ntpm = o.getAttribute('data-ntpm');
            const level = o.getAttribute('data-level');
            if (tissue && ntpm) {
              tooltip.innerHTML = `<strong>${tissue}</strong>: ${ntpm} nTPM (${level})`;
              tooltip.style.left = `${e.pageX + 10}px`;
              tooltip.style.top = `${e.pageY + 10}px`;
              tooltip.style.display = 'block';
            } else {
              tooltip.style.display = 'none';
            }
          });
          o.addEventListener('mouseleave', () => tooltip.style.display = 'none');
        });
        svgLoaded = true;
        return true;
      } catch (error) {
        console.error('Error loading SVG:', error.message);
        status.textContent = `Error loading anatomy diagram: ${error.message}. Please check if the SVG file exists and refresh the page.`;
        status.classList.add('error-message');
        svgLoaded = false;
        return false;
      }
    }

    async function loadCurated() {
      try {
        const resp = await fetch(CURATED_URL);
        if (!resp.ok) throw new Error(`Failed to load curated genes: ${resp.status}`);
        curatedGenes = await resp.json();
        if (!Array.isArray(curatedGenes)) curatedGenes = [];
      } catch (error) {
        console.error('Error loading curated genes:', error.message);
        curatedGenes = [];
      }
    }

    async function fetchGeneSpecific(geneSymbol) {
      try {
        const url = `${PER_GENE_DIR}/${encodeURIComponent(geneSymbol)}.json`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`Per-gene JSON not found: ${resp.status}`);
        return await resp.json();
      } catch (error) {
        throw new Error(`Failed to fetch gene-specific data: ${error.message}`);
      }
    }

    async function fetchFromBulk(geneSymbol) {
      try {
        const resp = await fetch(BULK_JSON_URL);
        if (!resp.ok) throw new Error(`Bulk JSON fetch failed: ${resp.status}`);
        const all = await resp.json();
        return all[geneSymbol] || all[geneSymbol.toUpperCase()] || null;
      } catch (error) {
        throw new Error(`Failed to fetch bulk data: ${error.message}`);
      }
    }

    function renderTable(geneData) {
      const entries = Object.entries(geneData).sort((a, b) => b[1] - a[1]);
      tbody.innerHTML = entries.map(([tissue, value]) => {
        const level = ntpmToLevel(value);
        return `<tr><td>${titleCaseTissue(tissue)}</td><td>${Number(value).toFixed(2)}</td><td>${level}</td></tr>`;
      }).join('');
      tableWrap.style.display = entries.length ? 'block' : 'none';
    }

    function paintOrgans(geneData) {
      if (!svgLoaded) {
        console.error('SVG not loaded, cannot paint organs');
        return;
      }
      resetOrgans();
      Object.entries(geneData).forEach(([tissue, nTPM]) => {
        const ids = TISSUE_TO_SVG_IDS[tissue.toLowerCase()];
        if (ids) {
          ids.forEach(id => {
            const node = svgRoot.getElementById ? svgRoot.getElementById(id) : document.getElementById(id);
            if (node) {
              node.style.fill = ntpmToColor(nTPM);
              node.setAttribute('data-tissue', titleCaseTissue(tissue));
              node.setAttribute('data-ntpm', Number(nTPM).toFixed(2));
              node.setAttribute('data-level', ntpmToLevel(nTPM));
            }
          });
        }
      });
    }

    async function searchGene(geneSymbol) {
      const g = (geneSymbol || '').trim();
      if (!g) {
        status.textContent = 'Please type a gene symbol.';
        status.classList.add('error-message');
        return;
      }
      currentGene = g.toUpperCase();
      status.textContent = `Loading ${currentGene}…`;
      status.classList.remove('error-message');
      try {
        if (!svgLoaded) {
          status.textContent = `Loading anatomy diagram...`;
          const svgSuccess = await loadSVG();
          if (!svgSuccess) {
            status.textContent = 'Failed to load anatomy diagram. Please check the SVG file and refresh the page.';
            status.classList.add('error-message');
            return;
          }
        }
        let data = null;
        try {
          data = await fetchGeneSpecific(currentGene);
        } catch {
          data = await fetchFromBulk(currentGene);
        }
        if (!data) {
          status.textContent = `No expression found for "${currentGene}".`;
          status.classList.add('error-message');
          resetOrgans();
          tbody.innerHTML = '';
          tableWrap.style.display = 'none';
          return;
        }
        paintOrgans(data);
        renderTable(data);
        status.textContent = `Showing expression for ${currentGene}`;
        status.classList.remove('error-message');
      } catch (err) {
        console.error('Search error:', err.message);
        status.textContent = `Error loading data for "${currentGene}": ${err.message}`;
        status.classList.add('error-message');
        resetOrgans();
        tbody.innerHTML = '';
        tableWrap.style.display = 'none';
      }
    }

    const geneInput = byId('geneInput');
    const suggestionsEl = byId('suggestions');
    const searchBtn = byId('searchBtn');

    function showSuggestions(list) {
      if (!list.length) {
        suggestionsEl.style.display = 'none';
        suggestionsEl.innerHTML = '';
        return;
      }
      suggestionsEl.innerHTML = list.slice(0, 12).map(g => `<div class="suggestion" data-g="${g}">${g}</div>`).join('');
      suggestionsEl.style.display = 'block';
      Array.from(suggestionsEl.children).forEach(div => {
        div.addEventListener('mousedown', (e) => {
          const g = e.currentTarget.getAttribute('data-g');
          geneInput.value = g;
          suggestionsEl.style.display = 'none';
          searchGene(g);
        });
      });
    }

    const onType = debounce(() => {
      const q = geneInput.value.trim().toUpperCase();
      if (!q) {
        showSuggestions([]);
        return;
      }
      if (!curatedGenes.length) {
        showSuggestions([]);
        return;
      }
      const matches = curatedGenes.filter(g => g.startsWith(q));
      showSuggestions(matches);
    }, 80);

    geneInput.addEventListener('input', onType);
    geneInput.addEventListener('focus', onType);
    geneInput.addEventListener('blur', () => setTimeout(() => suggestionsEl.style.display = 'none', 120));
    geneInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        suggestionsEl.style.display = 'none';
        searchGene(geneInput.value);
      }
    });
    searchBtn.addEventListener('click', () => searchGene(geneInput.value));

    // Navigation for SPA behavior
    window.navigateTo = function(event, path) {
      if (event) event.preventDefault();
      window.location.hash = path;
    };

    (async function init() {
      try {
        await Promise.all([loadSVG(), loadCurated()]);
        status.textContent = 'Type a gene symbol (e.g., ARL13B) and press Enter.';
        status.classList.remove('error-message');
      } catch (error) {
        console.error('Initialization error:', error.message);
        status.textContent = `Error initializing application: ${error.message}. Please refresh the page.`;
        status.classList.add('error-message');
      }
    })();
  </script>
</body>
</html>
