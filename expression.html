<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Expression Visualization - CiliaHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --green-low: #c8e6c9;   /* 0–5 nTPM */
            --green-med: #81c784;   /* 5–15 nTPM */
            --green-high: #4caf50;  /* 15–30 nTPM */
            --green-vhigh: #2e7d32; /* >30 nTPM */
            --no-data: #E0E0E0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); color: #333; min-height: 100vh; padding: 20px; }
        .app { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; padding: 30px 0; color: white; }
        header h1 { font-size: 2.8rem; margin-bottom: 10px; }
        header p { font-size: 1.2rem; max-width: 800px; margin: 0 auto; opacity: 0.9; }
        .grid { display: grid; grid-template-columns: 420px 1fr; gap: 28px; align-items: start; }
        .panel { background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.18); padding: 18px; }
        .search { display: flex; gap: 8px; align-items: center; position: relative; }
        .search input { width: 100%; max-width: 300px; padding: 12px 14px; font-size: 14px; border: 2px solid #e5e7eb; border-radius: 10px 0 0 10px; outline: none; }
        .search input:focus { border-color: #4a86e8; }
        .btn { padding: 12px 14px; border: none; border-radius: 0 10px 10px 0; background: #4a86e8; color: white; cursor: pointer; font-weight: 600; }
        .btn:hover { background: #3a76d8; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .suggestions { position: absolute; top: 48px; left: 0; width: 300px; max-height: 260px; overflow: auto; background: white; border: 1px solid #e5e7eb; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.12); display: none; z-index: 20; }
        .suggestion { padding: 10px 12px; cursor: pointer; }
        .suggestion:hover { background: #f3f4f6; }
        .legend { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #374151; }
        .sw { width: 18px; height: 18px; border-radius: 4px; border: 1px solid #d1d5db; }
        .table-wrap { margin-top: 16px; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        thead { background: #f8f9fa; }
        th, td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left; }
        tbody tr:hover { background: #fafafa; }
        .viz { position: relative; }
        #svgHost { width: 100%; display: flex; justify-content: center; }
        .tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; font-size: 12px; padding: 6px 8px; border-radius: 6px; pointer-events: none; opacity: 0; transition: opacity 0.15s ease-out; white-space: nowrap; transform: translate(-50%, -140%); }
        .organ { cursor: pointer; transition: filter 0.2s ease, stroke-width 0.2s ease; stroke: #333; stroke-width: 0.6; }
        .organ:hover { filter: brightness(1.15); stroke-width: 1.2; }
        .muted { color: #6b7280; font-size: 13px; }
        footer { text-align: center; padding: 20px; color: white; font-size: 0.9rem; opacity: 0.8; }
        @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .search { flex-direction: column; align-items: stretch; }
            .search input { max-width: none; border-radius: 10px; margin-bottom: 8px; }
            .btn { border-radius: 10px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>Gene Expression Visualization</h1>
            <p>Search a gene and explore its RNA expression across tissues & organs</p>
        </header>

        <div class="grid">
            <!-- LEFT: Search + Table -->
            <div class="panel">
                <div class="search">
                    <input id="geneInput" type="text" placeholder="Type gene (e.g., WDR31, ARL13B)" autocomplete="off">
                    <button id="searchBtn" class="btn">Search</button>
                    <div id="suggestions" class="suggestions"></div>
                </div>
                <div style="margin-top:8px" class="muted">Tip: Start typing to see suggestions (e.g., "AR" for ARL13B).</div>

                <div class="legend">
                    <div class="legend-item"><span class="sw" style="background:var(--green-low)"></span> Low (0–5 nTPM)</div>
                    <div class="legend-item"><span class="sw" style="background:var(--green-med)"></span> Medium (5–15)</div>
                    <div class="legend-item"><span class="sw" style="background:var(--green-high)"></span> High (15–30)</div>
                    <div class="legend-item"><span class="sw" style="background:var(--green-vhigh)"></span> Very High (&gt;30)</div>
                </div>

                <div id="status" style="margin-top:12px" class="muted"></div>

                <div class="table-wrap" id="tableWrap" style="display:none">
                    <table id="exprTable">
                        <thead><tr><th>Tissue / Organ</th><th>nTPM</th><th>Level</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- RIGHT: SVG Viz -->
            <div class="panel viz">
                <div id="svgHost">
                    <svg id="humanSvg" class="human-svg" viewBox="0 0 453.54 815.12" xmlns="http://www.w3.org/2000/svg">
                        <g id="body-outline" fill="#f0f0f0" stroke="#cccccc" stroke-width="0.5">
                            <path d="M226.77,815.12C101.48,815.12,0,713.64,0,588.35c0-125.29,101.48-226.77,226.77-226.77s226.77,101.48,226.77,226.77C453.54,713.64,352.06,815.12,226.77,815.12ZM226.77,365.58c-122.99,0-222.77,99.78-222.77,222.77s99.78,222.77,222.77,222.77,222.77-99.78,222.77-222.77S349.76,365.58,226.77,365.58Z"/>
                        </g>
                        <path id="path-colon" class="organ" fill="#E0E0E0" d="M294.57,489.28c-.46-1.15-1.03-2.24-1.60-3.34-19.10-37.58-52.68-62.85-92.41-62.85s-73.31,25.27-92.41,62.85c-.58,1.10-1.14,2.19-1.60,3.34H58.14c-1.49,0-2.69-1.20-2.69-2.69v-13.04c0-1.49,1.20-2.69,2.69-2.69h30.29c11.01-44.50,51.84-78.11,100.32-78.11s89.31,33.61,100.32,78.11h30.29c1.49,0,2.69,1.20,2.69,2.69v13.04c0,1.49-1.20,2.69-2.69,2.69h-22.10Z"/>
                        <path id="path-stomach" class="organ" fill="#E0E0E0" d="M167.31,407.50c-20.14,4.24-34.93,17.43-34.93,33.15,0,19.33,26.43,35,59,35s59-15.67,59-35c0-14.16-11.45-26.31-28.52-31.67-12.78-3.99-28.32-6.28-44.56-1.48Z"/>
                        <path id="path-small-intestine" class="organ" fill="#E0E0E0" d="M204.40,422.36c-20.44,0-37,16.56-37,37s16.56,37,37,37,37-16.56,37-37-16.56-37-37-37Z"/>
                        <path id="path-pancreas" class="organ" fill="#E0E0E0" d="M223.59,428.18c-12.23,2.40-19.89,6.77-19.89,11.82s8.91,12.50,21.14,12.50,21.14-5.60,21.14-12.50-4.22-9.98-14.77-11.58c-4.73-.72-9.72-.94-17.62-.24Z"/>
                        <path id="path-gall-bladder" class="organ" fill="#E0E0E0" d="M225.83,398.05c-4.99,0-9.04,4.05-9.04,9.04s4.05,9.04,9.04,9.04,9.04-4.05,9.04-9.04-4.05-9.04-9.04-9.04Z"/>
                        <path id="path-liver" class="organ" fill="#E0E0E0" d="M282.02,408.08c-23.71,5.65-48.45,8.80-74.45,8.80s-50.75-3.15-74.45-8.80c-2.31-.55-4.57-1.12-6.75-1.72-13.84-3.79-24.80-13.80-24.80-28.92,0-16.57,13.43-30,30-30h149.20c16.57,0,30,13.43,30,30,0,15.12-10.96,25.13-24.80,28.92-2.18.60-4.44,1.17-6.75,1.72Z"/>
                        <path id="path-spleen" class="organ" fill="#E0E0E0" d="M154.67,406.88c-10.15,2.14-17.55,8.76-17.55,16.67,0,9.72,13.28,17.60,29.65,17.60s29.65-7.88,29.65-17.60c0-7.07-5.74-13.13-14.33-15.91-6.42-2.08-14.23-3.15-22.38-.92-1.72.48-3.41,1.02-5.08,1.57Z"/>
                        <path id="path-adrenal-gland-right" class="organ" fill="#E0E0E0" d="M278.47,403.95c.53-2.82,2.98-4.96,5.88-4.96,3.31,0,6,2.69,6,6,0,2.16-1.14,4.04-2.85,5.08-1.55.94-3.32,1.56-5.23,1.82l-3.80-.46Z"/>
                        <path id="path-kidney-right" class="organ" fill="#E0E0E0" d="M281.33,407.97c-9.08,5.18-14.83,13.62-14.83,23.30,0,15.25,12.32,27.57,27.57,27.57s27.57-12.32,27.57-27.57c0-9.68-5.75-18.12-14.83-23.30h-25.49Z"/>
                        <path id="path-adrenal-gland-left" class="organ" fill="#E0E0E0" d="M153.95,403.49c-.53-2.82-2.98-4.96-5.88-4.96-3.31,0-6,2.69-6,6,0,2.16,1.14,4.04,2.85,5.08,1.55.94,3.32,1.56,5.23,1.82l3.80-.46Z"/>
                        <path id="path-kidney-left" class="organ" fill="#E0E0E0" d="M123.67,407.51c9.08,5.18,14.83,13.62,14.83,23.30,0,15.25,12.32,27.57,27.57,27.57s27.57-12.32,27.57-27.57c0-9.68-5.75-18.12-14.83-23.30H123.67Z"/>
                        <path id="path-esophagus" class="organ" fill="#E0E0E0" d="M212.87,314.93c-4.42,0-8,12.13-8,27.10s3.58,27.10,8,27.10h21.01c4.42,0,8-12.13,8-27.10s-3.58-27.10-8-27.10h-21.01Z"/>
                        <path id="path-trachea" class="organ" fill="#E0E0E0" d="M215.17,253.90c-2.76,0-5,11.24-5,25.10s2.24,25.10,5,25.10h16.44c2.76,0,5-11.24,5-25.10s-2.24-25.10-5-25.10h-16.44Z"/>
                        <path id="path-heart" class="organ" fill="#E0E0E0" d="M239.54,345.54c-13.88,7.90-31.54,7.90-45.42,0-4.60-2.62-7.46-7.53-7.46-12.98,0-8.54,6.92-15.46,15.46-15.46h29.42c8.54,0,15.46,6.92,15.46,15.46,0,5.45-2.85,10.36-7.46,12.98Z"/>
                        <path id="path-lung-right" class="organ" fill="#E0E0E0" d="M307.25,322.95c-19.49,15.18-45.89,24.80-74.88,24.80h-11.75c-2.47-5.96-5.46-12.44-8.87-19.14-10.23-19.98-22.30-43.58-22.30-69.65,0-36.29,19.24-66.96,48.09-84.34,3.70-2.23,7.99-3.80,12.69-4.83,23.33-5.11,46.12,4.80,55.90,23.10,12.23,22.90,10.63,50.48-1.50,72.19,3.87,5.55,6.70,11.96,8.44,18.84,1.86,7.41.93,15.20-2.07,21.99,1.07,2.23,1.96,4.55,2.67,6.96,1.40,4.78,1.40,9.79,0,14.57Z"/>
                        <path id="path-lung-left" class="organ" fill="#E0E0E0" d="M146.29,322.95c19.49,15.18,45.89,24.80,74.88,24.80h11.75c2.47-5.96,5.46-12.44,8.87-19.14,10.23-19.98,22.30-43.58,22.30-69.65,0-36.29-19.24-66.96-48.09-84.34-3.70-2.23-7.99-3.80-12.69-4.83-23.33-5.11-46.12,4.80-55.90,23.10-12.23,22.90-10.63,50.48,1.50,72.19-3.87-5.55-6.70-11.96-8.44-18.84-1.86-7.41-.93-15.20,2.07-21.99-1.07-2.23-1.96-4.55-2.67-6.96-1.40-4.78-1.40-9.79,0-14.57Z"/>
                        <path id="path-thyroid" class="organ" fill="#E0E0E0" d="M202.90,244.62c-3.15,1.70-5.41,4.92-5.41,8.65s2.26,6.95,5.41,8.65c3.15-1.70,5.41-4.92,5.41-8.65s-2.26-6.95-5.41-8.65Z"/>
                        <path id="path-brain" class="organ" fill="#E0E0E0" d="M226.77,157.07c-44.18,0-80-35.82-80-80s35.82-80,80-80,80,35.82,80,80-35.82,80-80,80Z"/>
                        <path id="path-cerebellum" class="organ" fill="#E0E0E0" d="M226.77,133.56c-17.67,0-32-14.33-32-32s14.33-32,32-32,32,14.33,32,32-14.33,32-32,32Z"/>
                        <path id="path-endometrium" class="organ" fill="#E0E0E0" d="M204.99,521.13c-1.50,0-2.72-1.22-2.72-2.72v-13.62c0-1.50,1.22-2.72,2.72-2.72h33.57c1.50,0,2.72,1.22,2.72,2.72v13.62c0,1.50-1.22,2.72-2.72,2.72h-33.57Z"/>
                        <path id="path-prostate" class="organ" fill="#E0E0E0" d="M208.57,515.22c-3.31,0-6,2.69-6,6s2.69,6,6,6h26.40c3.31,0,6-2.69,6-6s-2.69-6-6-6h-26.40Z"/>
                        <path id="path-seminal-vesicle" class="organ" fill="#E0E0E0" d="M212.87,515.22c-1.11,0-2,1.79-2,4s.89,4,2,4h17.80c1.11,0,2-1.79,2-4s-.89-4-2-4h-17.80Z"/>
                        <path id="path-testis-right" class="organ" fill="#E0E0E0" d="M242.06,536.43c-6.83,3.31-14.53,5.15-22.65,5.15-19.46,0-36.94-8.08-49.02-21.20-1.63-1.77-2.60-4.10-2.60-6.58,0-5.10,4.14-9.24,9.24-9.24h21.46c.39-4.88,2.30-9.50,5.30-13.38.70-.91,1.48-1.76,2.33-2.54,6.72-6.17,15.65-9.79,25.43-9.79,19.34,0,36.56,12.75,44.25,31.05,2.44,5.82,3.80,12.16,3.80,18.82,0,17.47-8.32,33.05-21.19,42.54Z"/>
                        <path id="path-testis-left" class="organ" fill="#E0E0E0" d="M211.48,536.43c6.83,3.31,14.53,5.15,22.65,5.15,19.46,0,36.94-8.08,49.02-21.20,1.63-1.77,2.60-4.10,2.60-6.58,0-5.10-4.14-9.24-9.24-9.24h-21.46c-.39-4.88-2.30-9.50-5.30-13.38-.70-.91-1.48-1.76-2.33-2.54-6.72-6.17-15.65-9.79-25.43-9.79-19.34,0-36.56,12.75-44.25,31.05-2.44,5.82-3.80,12.16-3.80,18.82,0,17.47,8.32,33.05,21.19,42.54Z"/>
                        <path id="path-epididymis-right" class="organ" fill="#E0E0E0" d="M244.75,528.89c-2.73,1.32-5.81,2.06-9.06,2.06-7.78,0-14.78-3.23-19.61-8.48-.65-.71-1.04-1.64-1.04-2.63,0-2.04,1.66-3.70,3.70-3.70h8.58c.16-1.95.92-3.80,2.12-5.35.28-.36.59-.70,1.04-1.22,2.69-2.47,6.26-3.92,10.17-3.92,7.74,0,14.62,5.10,17.70,12.42.98,2.33,1.52,4.86,1.52,7.53,0,6.99-3.33,13.22-8.48,17.02Z"/>
                        <path id="path-epididymis-left" class="organ" fill="#E0E0E0" d="M208.79,528.89c2.73,1.32,5.81,2.06,9.06,2.06,7.78,0,14.78-3.23,19.61-8.48.65-.71,1.04-1.64,1.04-2.63,0-2.04-1.66-3.70-3.70-3.70h-8.58c-.16-1.95-.92-3.80-2.12-5.35-.28-.36-.59-.70-1.04-1.22-2.69-2.47,6.26-3.92,10.17-3.92-7.74,0-14.62,5.10-17.70,12.42-.98-2.33-1.52-4.86-1.52-7.53,0,6.99,3.33,13.22,8.48,17.02Z"/>
                        <path id="path-fallopian-tube-right" class="organ" fill="#E0E0E0" d="M268.04,500.22c-1.39,3.15-2.26,6.58-2.26,10.20,0,11.05,8.95,20,20,20s20-8.95,20-20c0-3.62-.96-7.05-2.26-10.20h-35.48Z"/>
                        <path id="path-ovary-right" class="organ" fill="#E0E0E0" d="M269.83,522.63c-3.31,0-6,2.69-6,6s2.69,6,6,6,6-2.69,6-6-2.69-6-6-6Z"/>
                        <path id="path-fallopian-tube-left" class="organ" fill="#E0E0E0" d="M142.27,500.22c1.39,3.15,2.26,6.58,2.26,10.20,0,11.05-8.95,20-20,20s-20-8.95-20-20c0-3.62.96-7.05,2.26-10.20h35.48Z"/>
                        <path id="path-ovary-left" class="organ" fill="#E0E0E0" d="M175.70,522.63c-3.31,0-6,2.69-6,6s2.69,6,6,6,6-2.69,6-6-2.69-6-6-6Z"/>
                        <path id="path-placenta" class="organ" fill="#E0E0E0" d="M226.77,509.39c-22.09,0-40,17.91-40,40s17.91,40,40,40,40-17.91,40-40-17.91-40-40-40Z"/>
                        <path id="path-cervix" class="organ" fill="#E0E0E0" d="M222.15,532.84c-1.50,0-2.72-1.22-2.72-2.72v-13.62c0-1.50,1.22-2.72,2.72-2.72h8.49c1.50,0,2.72,1.22,2.72,2.72v13.62c0,1.50-1.22,2.72-2.72,2.72h-8.49Z"/>
                        <path id="path-bone-marrow" class="organ" fill="#E0E0E0" d="M226.77,654.49c-38.66,0-70-31.34-70-70s31.34-70,70-70,70,31.34,70,70-31.34,70-70,70Z"/>
                        <path id="path-adipose" class="organ" fill="#E0E0E0" d="M109.95,453.79c-11.05,0-20,8.95-20,20s8.95,20,20,20,20-8.95,20-20-8.95-20-20-20Z"/>
                        <path id="path-muscle" class="organ" fill="#E0E0E0" d="M343.59,453.79c-11.05,0-20,8.95-20,20s8.95,20,20,20,20-8.95,20-20-8.95-20-20-20Z"/>
                        <path id="path-skin" class="organ" fill="#E0E0E0" d="M109.95,357.57c-11.05,0-20,8.95-20,20s8.95,20,20,20,20-8.95,20-20-8.95-20-20-20Z"/>
                        <path id="path-smooth-muscle" class="organ" fill="#E0E0E0" d="M343.59,357.57c-11.05,0-20,8.95-20,20s8.95,20,20,20,20-8.95,20-20-8.95-20-20-20Z"/>
                    </svg>
                </div>
                <div id="tooltip" class="tooltip"></div>
            </div>
        </div>

        <footer>
            <p>© 2025 CiliaHub | Gene Expression Database | Data source: Human Protein Atlas</p>
        </footer>
    </div>

    <script>
        // Config
        const SVG_URL = "/file.svg"; // Not used since SVG is embedded
        const CURATED_URL = "/curated_genes.json";
        const BULK_JSON_URL = "/rna_tissue_consensus.json";
        const PER_GENE_DIR = "/genes";
        const TISSUE_TO_SVG_IDS = {
            "adipose tissue": ["path-adipose"],
            "adrenal gland": ["path-adrenal-gland-left", "path-adrenal-gland-right"],
            "bone marrow": ["path-bone-marrow"],
            "brain": ["path-brain", "path-cerebellum"],
            "cerebellum": ["path-cerebellum"],
            "cervix, uterine": ["path-cervix"],
            "colon": ["path-colon"],
            "endometrium": ["path-endometrium"],
            "epididymis": ["path-epididymis-left", "path-epididymis-right"],
            "esophagus": ["path-esophagus"],
            "fallopian tube": ["path-fallopian-tube-left", "path-fallopian-tube-right"],
            "gallbladder": ["path-gall-bladder"],
            "heart muscle": ["path-heart"],
            "kidney": ["path-kidney-left", "path-kidney-right"],
            "liver": ["path-liver"],
            "lung": ["path-lung-left", "path-lung-right"],
            "ovary": ["path-ovary-left", "path-ovary-right"],
            "pancreas": ["path-pancreas"],
            "placenta": ["path-placenta"],
            "prostate": ["path-prostate"],
            "seminal vesicle": ["path-seminal-vesicle"],
            "skeletal muscle": ["path-muscle"],
            "skin": ["path-skin"],
            "small intestine": ["path-small-intestine"],
            "smooth muscle": ["path-smooth-muscle"],
            "spleen": ["path-spleen"],
            "stomach": ["path-stomach"],
            "testis": ["path-testis-left", "path-testis-right"],
            "thyroid gland": ["path-thyroid"],
            "trachea": ["path-trachea"]
        };

        // State
        let curatedGenes = [];
        let svgRoot = null;
        let organs = [];
        let currentGene = null;
        const tooltip = document.getElementById('tooltip');
        const byId = (id) => document.getElementById(id);
        const status = byId('status');
        const tableWrap = byId('tableWrap');
        const tbody = document.querySelector('#exprTable tbody');
        const geneInput = byId('geneInput');
        const suggestionsEl = byId('suggestions');
        const searchBtn = byId('searchBtn');

        // Helpers
        function ntpmToLevel(n) {
            if (n <= 5) return 'Low';
            if (n <= 15) return 'Medium';
            if (n <= 30) return 'High';
            return 'Very High';
        }
        function ntpmToColor(n) {
            return getComputedStyle(document.documentElement).getPropertyValue(
                n <= 5 ? '--green-low' : n <= 15 ? '--green-med' : n <= 30 ? '--green-high' : '--green-vhigh'
            ).trim();
        }
        function resetOrgans() {
            organs.forEach(o => {
                o.style.fill = getComputedStyle(document.documentElement).getPropertyValue('--no-data').trim();
                o.removeAttribute('data-tissue');
                o.removeAttribute('data-ntpm');
                o.removeAttribute('data-level');
            });
            tooltip.style.opacity = 0;
        }
        function titleCaseTissue(t) {
            return t.replace(/,/g, '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }
        function debounce(fn, delay = 120) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }

        // Load SVG and Curated Genes
        async function loadSVG() {
            svgRoot = byId('humanSvg');
            organs = svgRoot.querySelectorAll('.organ');
            organs.forEach(o => {
                o.addEventListener('mousemove', (e) => {
                    const tissue = o.getAttribute('data-tissue');
                    const ntpm = o.getAttribute('data-ntpm');
                    const level = o.getAttribute('data-level');
                    if (tissue && ntpm) {
                        tooltip.innerHTML = `<strong>${tissue}</strong>: ${ntpm} nTPM (${level})`;
                        tooltip.style.left = `${e.clientX - byId('svgHost').getBoundingClientRect().left}px`;
                        tooltip.style.top = `${e.clientY - byId('svgHost').getBoundingClientRect().top - 50}px`;
                        tooltip.style.opacity = 1;
                    } else {
                        tooltip.style.opacity = 0;
                    }
                });
                o.addEventListener('mouseleave', () => tooltip.style.opacity = 0);
            });
        }
        async function loadCurated() {
            try {
                const resp = await fetch(CURATED_URL);
                if (!resp.ok) throw new Error('No curated list');
                curatedGenes = await resp.json();
                if (!Array.isArray(curatedGenes)) curatedGenes = [];
                console.log(`Loaded ${curatedGenes.length} curated genes`);
            } catch {
                curatedGenes = [];
                console.warn('Curated genes not loaded; suggestions disabled');
            }
        }

        // Data Fetchers
        async function fetchGeneSpecific(geneSymbol) {
            const url = `${PER_GENE_DIR}/${encodeURIComponent(geneSymbol)}.json`;
            console.log(`Fetching per-gene data: ${url}`);
            const resp = await fetch(url, { cache: 'no-store' });
            if (resp.ok) return await resp.json();
            throw new Error('Per-gene JSON not found');
        }
        async function fetchFromBulk(geneSymbol) {
            console.log(`Fetching bulk data: ${BULK_JSON_URL}`);
            const resp = await fetch(BULK_JSON_URL);
            if (!resp.ok) throw new Error(`Bulk JSON fetch failed: ${resp.status}`);
            const all = await resp.json();
            return all[geneSymbol] || all[geneSymbol.toUpperCase()] || null;
        }

        // Rendering
        function renderTable(geneData) {
            const entries = Object.entries(geneData).sort((a, b) => b[1] - a[1]);
            tbody.innerHTML = entries.map(([tissue, value]) => {
                const level = ntpmToLevel(value);
                return `<tr><td>${titleCaseTissue(tissue)}</td><td>${Number(value).toFixed(2)}</td><td>${level}</td></tr>`;
            }).join('');
            tableWrap.style.display = entries.length ? 'block' : 'none';
        }
        function paintOrgans(geneData) {
            resetOrgans();
            Object.entries(geneData).forEach(([tissue, nTPM]) => {
                const ids = TISSUE_TO_SVG_IDS[tissue.toLowerCase()];
                if (ids) {
                    ids.forEach(id => {
                        const node = document.getElementById(id);
                        if (node) {
                            node.style.fill = ntpmToColor(nTPM);
                            node.setAttribute('data-tissue', titleCaseTissue(tissue));
                            node.setAttribute('data-ntpm', Number(nTPM).toFixed(2));
                            node.setAttribute('data-level', ntpmToLevel(nTPM));
                        } else {
                            console.warn(`No SVG node for ID: ${id}`);
                        }
                    });
                } else {
                    console.warn(`No SVG mapping for tissue: ${tissue}`);
                }
            });
        }

        // Search
        async function searchGene(geneSymbol) {
            const g = (geneSymbol || '').trim();
            if (!g) {
                status.textContent = 'Please type a gene symbol.';
                resetOrgans();
                tbody.innerHTML = '';
                tableWrap.style.display = 'none';
                return;
            }
            currentGene = g.toUpperCase();
            status.textContent = `Loading ${currentGene}…`;
            searchBtn.disabled = true;
            try {
                let data = null;
                try {
                    data = await fetchGeneSpecific(currentGene);
                } catch {
                    data = await fetchFromBulk(currentGene);
                }
                if (!data) {
                    status.textContent = `No expression found for "${currentGene}".`;
                    resetOrgans();
                    tbody.innerHTML = '';
                    tableWrap.style.display = 'none';
                    return;
                }
                paintOrgans(data);
                renderTable(data);
                status.textContent = `Showing expression for ${currentGene}`;
            } catch (err) {
                console.error('Search error:', err);
                status.textContent = `Error loading data for "${currentGene}". Check console (F12) for details.`;
                resetOrgans();
                tbody.innerHTML = '';
                tableWrap.style.display = 'none';
            } finally {
                searchBtn.disabled = false;
            }
        }

        // Type-ahead
        function showSuggestions(list) {
            if (!list.length) {
                suggestionsEl.style.display = 'none';
                suggestionsEl.innerHTML = '';
                return;
            }
            suggestionsEl.innerHTML = list.slice(0, 12).map(g => `<div class="suggestion" data-g="${g}">${g}</div>`).join('');
            suggestionsEl.style.display = 'block';
            Array.from(suggestionsEl.children).forEach(div => {
                div.addEventListener('mousedown', (e) => {
                    const g = e.currentTarget.getAttribute('data-g');
                    geneInput.value = g;
                    suggestionsEl.style.display = 'none';
                    searchGene(g);
                });
            });
        }
        const onType = debounce(() => {
            const q = geneInput.value.trim().toUpperCase();
            if (!q || !curatedGenes.length) {
                showSuggestions([]);
                return;
            }
            const matches = curatedGenes.filter(g => g.startsWith(q));
            showSuggestions(matches);
        }, 80);
        geneInput.addEventListener('input', onType);
        geneInput.addEventListener('focus', onType);
        geneInput.addEventListener('blur', () => setTimeout(() => suggestionsEl.style.display = 'none', 120));
        geneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                suggestionsEl.style.display = 'none';
                searchGene(geneInput.value);
            }
        });
        searchBtn.addEventListener('click', () => searchGene(geneInput.value));

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadSVG(), loadCurated()]);
            status.textContent = 'Type a gene symbol (e.g., WDR31, ARL13B) and press Enter.';
        });
    </script>
</body>
</html>
