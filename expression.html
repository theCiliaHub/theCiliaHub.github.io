<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiliaHub - Gene Expression Visualization</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            color: #2c3e50; 
            line-height: 1.6; 
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1);
        }
        
        .header h1 {
            color: #2c5aa0;
            margin-bottom: 1rem;
        }
        
        .header p {
            color: #555;
            font-size: 1.1rem;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: start;
        }
        
        .search-panel {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1);
            height: fit-content;
        }
        
        .search-panel h3 {
            color: #2c5aa0;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }
        
        .search-container {
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e1ecf4;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        .suggestions {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e1ecf4;
            border-radius: 8px;
            background: white;
            display: none;
        }
        
        .suggestion-item {
            padding: 0.8rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-gene {
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .suggestion-description {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.3rem;
        }
        
        .expression-panel {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(44, 90, 160, 0.1);
        }
        
        .expression-panel h3 {
            color: #2c5aa0;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }
        
        .human-body-container {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .human-body-svg {
            max-width: 100%;
            height: auto;
        }
        
        .organ {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .organ:hover {
            filter: brightness(1.1);
        }
        
        .expression-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .expression-table-container {
            margin-top: 2rem;
        }
        
        .expression-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .expression-table th,
        .expression-table td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #e1ecf4;
        }
        
        .expression-table th {
            background: #2c5aa0;
            color: white;
            font-weight: 600;
        }
        
        .expression-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .expression-value {
            font-weight: 600;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            text-align: center;
            min-width: 80px;
        }
        
        .expression-low { background-color: #A8E6A1; color: #1E7B1E; }
        .expression-medium { background-color: #6CC96C; color: #1E7B1E; }
        .expression-high { background-color: #3FAF3F; color: white; }
        .expression-very-high { background-color: #1E7B1E; color: white; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .error {
            color: #dc3545;
            text-align: center;
            padding: 1rem;
            background: #f8d7da;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gene Expression Visualization</h1>
            <p>Explore tissue-specific gene expression patterns across human organs and tissues</p>
        </div>
        
        <div class="main-layout">
            <!-- Left Panel: Search -->
            <div class="search-panel">
                <h3>Gene Search</h3>
                <div class="search-container">
                    <input 
                        type="text" 
                        id="gene-search" 
                        class="search-input" 
                        placeholder="Search for a gene (e.g., ARL13B, IFT88)"
                        autocomplete="off"
                    >
                    <div id="suggestions" class="suggestions"></div>
                </div>
                
                <div id="selected-gene-info" style="display: none;">
                    <h4 style="color: #2c5aa0; margin-bottom: 1rem;">Selected Gene</h4>
                    <div id="gene-details"></div>
                </div>
            </div>
            
            <!-- Right Panel: Expression Visualization -->
            <div class="expression-panel">
                <h3>Expression Visualization</h3>
                
                <div class="human-body-container">
                    <div id="svg-container" style="max-width: 100%; height: auto;">
                        <!-- SVG will be loaded here -->
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>Loading human body visualization...</p>
                        </div>
                    </div>
                </div>
                
                <div class="expression-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #A8E6A1;"></div>
                        <span>Low (0-5 nTPM)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #6CC96C;"></div>
                        <span>Medium (5-15 nTPM)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3FAF3F;"></div>
                        <span>High (15-30 nTPM)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #1E7B1E;"></div>
                        <span>Very High (>30 nTPM)</span>
                    </div>
                </div>
                
                <div class="expression-table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #2c5aa0; margin: 0;">Expression Data Table</h4>
                        <button id="reset-organs-btn" style="padding: 0.5rem 1rem; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;" onclick="resetOrganSelection()">
                            Reset Organ Selection
                        </button>
                    </div>
                    <div id="expression-table-wrapper">
                        <div class="no-data">Click on an organ to see its gene expression data, or search for a specific gene</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gene data and expression data
        let geneData = [];
        let expressionData = [];
        let selectedGene = null;
        
        // Available genes (limited to 2011 for performance)
        const availableGenes = new Set();
        
        // Initialize the application
        async function init() {
            try {
                await loadGeneData();
                await loadExpressionData();
                await loadSVGFile();
                setupEventListeners();
                console.log('Application initialized successfully');
            } catch (error) {
                console.error('Failed to initialize application:', error);
                showError('Failed to initialize application. Please refresh the page.');
            }
        }
        
        // Load gene data from ciliahub_data.json (for additional info only)
        async function loadGeneData() {
            try {
                const response = await fetch('ciliahub_data.json');
                if (!response.ok) throw new Error('Failed to load gene data');
                
                geneData = await response.json();
                console.log(`Loaded ${geneData.length} genes for additional info`);
            } catch (error) {
                console.error('Error loading gene data:', error);
                // Continue without gene data - we'll use TSV data for search
            }
        }
        
        // Load expression data from RNA tissue consensus
        async function loadExpressionData() {
            try {
                console.log('🔄 Loading expression data from TSV...');
                const response = await fetch('rna_tissue_consensus.tsv');
                if (!response.ok) throw new Error('Failed to load expression data');
                
                const tsvText = await response.text();
                console.log('📄 TSV text loaded, length:', tsvText.length);
                
                const rawData = parseTSV(tsvText);
                console.log('📊 Parsed TSV data, rows:', rawData.length);
                
                expressionData = processExpressionData(rawData);
                
                // Build available genes set from TSV data (not from ciliahub_data.json)
                const geneSet = new Set();
                Object.keys(expressionData).forEach(gene => {
                    geneSet.add(gene.toUpperCase());
                });
                availableGenes = geneSet;
                
                console.log(`✅ Loaded ${Object.keys(expressionData).length} genes with expression data from TSV`);
                console.log(`🔍 Available genes count: ${availableGenes.size}`);
                
                // Debug: Show first few genes
                const firstGenes = Array.from(availableGenes).slice(0, 5);
                console.log('🔍 First 5 available genes:', firstGenes);
                
            } catch (error) {
                console.error('❌ Error loading expression data:', error);
                // Continue without expression data - show message to user
                showError('Expression data not available. Gene search will still work.');
            }
        }
        
        // Parse TSV data
        function parseTSV(tsvText) {
            const lines = tsvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            const headers = lines[0].split('\t');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t');
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }
        
        // Process TSV data into a more usable format for organ expression
        function processExpressionData(rawData) {
            const processedData = {};
            
            rawData.forEach(row => {
                const geneName = row['Gene name'] || row['Gene'];
                const tissue = row['Tissue'];
                const nTPM = parseFloat(row['nTPM']);
                
                if (geneName && tissue && !isNaN(nTPM)) {
                    if (!processedData[geneName]) {
                        processedData[geneName] = {};
                    }
                    processedData[geneName][tissue] = nTPM;
                }
            });
            
            return processedData;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            const searchInput = document.getElementById('gene-search');
            const suggestionsDiv = document.getElementById('suggestions');
            
            // Search input events
            searchInput.addEventListener('input', handleSearchInput);
            searchInput.addEventListener('focus', showSuggestions);
            searchInput.addEventListener('blur', () => {
                // Delay hiding suggestions to allow clicking
                setTimeout(() => suggestionsDiv.style.display = 'none', 200);
            });
            
            // Click outside to hide suggestions
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }
        
        // Handle search input
        // Debounce search input for better performance
        let searchTimeout;
        function handleSearchInput(e) {
            const query = e.target.value.trim().toUpperCase();
            
            if (query.length < 2) {
                hideSuggestions();
                return;
            }
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            // Debounce search to avoid excessive function calls
            searchTimeout = setTimeout(() => {
                const suggestions = getGeneSuggestions(query);
                showSuggestions(suggestions);
            }, 150); // 150ms delay
        }
        
        // Get gene suggestions based on query
        function getGeneSuggestions(query) {
            const suggestions = [];
            
            // Search in available genes
            for (const gene of availableGenes) {
                if (gene.startsWith(query)) {
                    const geneInfo = geneData.find(g => g.gene.toUpperCase() === gene);
                    if (geneInfo) {
                        suggestions.push({
                            gene: geneInfo.gene,
                            description: geneInfo.description || 'No description available',
                            ensembl_id: geneInfo.ensembl_id
                        });
                    }
                    
                    if (suggestions.length >= 10) break; // Limit suggestions
                }
            }
            
            return suggestions;
        }
        
        // Show suggestions
        function showSuggestions(suggestions = null) {
            const suggestionsDiv = document.getElementById('suggestions');
            
            if (!suggestions) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            if (suggestions.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            suggestionsDiv.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-item" onclick="selectGene('${suggestion.gene}')">
                    <div class="suggestion-gene">${suggestion.gene}</div>
                    <div class="suggestion-description">${suggestion.description.substring(0, 80)}${suggestion.description.length > 80 ? '...' : ''}</div>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
        }
        
        // Hide suggestions
        function hideSuggestions() {
            document.getElementById('suggestions').style.display = 'none';
        }
        
        // Select a gene
        function selectGene(geneName) {
            selectedGene = geneName;
            
            // Update UI
            document.getElementById('gene-search').value = geneName;
            hideSuggestions();
            
            // Show gene info
            showGeneInfo(geneName);
            
            // Update expression visualization
            updateExpressionVisualization(geneName);
            
            // Update expression table
            updateExpressionTable(geneName);
        }
        
        // Show gene information
        function showGeneInfo(geneName) {
            const geneInfo = geneData.find(g => g.gene === geneName);
            const geneDetailsDiv = document.getElementById('gene-details');
            const selectedGeneInfoDiv = document.getElementById('selected-gene-info');
            
            if (geneInfo) {
                geneDetailsDiv.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        <strong>Gene:</strong> ${geneInfo.gene}
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Description:</strong> ${geneInfo.description || 'No description available'}
                    </div>
                    ${geneInfo.ensembl_id ? `<div style="margin-bottom: 1rem;"><strong>Ensembl ID:</strong> ${geneInfo.ensembl_id}</div>` : ''}
                    ${geneInfo.localization ? `<div style="margin-bottom: 1rem;"><strong>Localization:</strong> ${geneInfo.localization}</div>` : ''}
                `;
                selectedGeneInfoDiv.style.display = 'block';
            }
        }
        
        // Update expression visualization on organs
        function updateExpressionVisualization(geneName) {
            // Reset all organs to their original colors
            const organs = document.querySelectorAll('.organ');
            organs.forEach(organ => {
                const originalColor = organ.getAttribute('data-original-color');
                if (originalColor) {
                    organ.setAttribute('fill', originalColor);
                }
                organ.setAttribute('title', '');
            });
            
            // Find expression data for the gene
            const geneExpression = findGeneExpression(geneName);
            
            if (geneExpression) {
                // Apply expression colors to organs
                Object.entries(geneExpression).forEach(([tissue, nTPM]) => {
                    const organElement = findOrganElement(tissue);
                    if (organElement) {
                        const color = getExpressionColor(nTPM);
                        organElement.setAttribute('fill', color);
                        
                        // Add tooltip with exact nTPM value and description
                        const description = organElement.getAttribute('data-description') || tissue;
                        organElement.setAttribute('title', `${description}: ${nTPM} nTPM`);
                    }
                });
            }
        }
        
        // Find gene expression data
        function findGeneExpression(geneName) {
            if (!expressionData || Object.keys(expressionData).length === 0) return null;
            
            // Look for exact gene match in the processed data
            const geneRecord = expressionData[geneName.toUpperCase()];
            
            if (geneRecord) {
                return geneRecord;
            }
            
            // Try to find by partial match
            const matchingGene = Object.keys(expressionData).find(gene => 
                gene.toUpperCase() === geneName.toUpperCase()
            );
            
            if (matchingGene) {
                return expressionData[matchingGene];
            }
            
            return null;
        }
        
        // Find organ element by tissue name
        function findOrganElement(tissueName) {
            // Look for organs by their data-tissue attribute
            const organs = document.querySelectorAll('.organ');
            
            for (const organ of organs) {
                const tissue = organ.getAttribute('data-tissue');
                if (tissue && tissueName.toLowerCase().includes(tissue)) {
                    return organ;
                }
            }
            
            return null;
        }
        
        // Get expression color based on nTPM value
        function getExpressionColor(nTPM) {
            if (nTPM <= 5) return '#A8E6A1';      // Light green - Low expression (0-5 nTPM)
            if (nTPM <= 15) return '#6CC96C';     // Medium green - Medium expression (5-15 nTPM)
            if (nTPM <= 30) return '#3FAF3F';     // Green - High expression (15-30 nTPM)
            return '#1E7B1E';                      // Dark green - Very high expression (>30 nTPM)
        }
        
        // Update expression table
        function updateExpressionTable(geneName) {
            const tableWrapper = document.getElementById('expression-table-wrapper');
            const geneExpression = findGeneExpression(geneName);
            
            if (!geneExpression || Object.keys(geneExpression).length === 0) {
                tableWrapper.innerHTML = '<div class="no-data">No expression data available for this gene</div>';
                return;
            }
            
            // Sort tissues by expression level
            const sortedTissues = Object.entries(geneExpression)
                .sort(([,a], [,b]) => b - a);
            
            const tableHTML = `
                <table class="expression-table">
                    <thead>
                        <tr>
                            <th>Tissue/Organ</th>
                            <th>nTPM Value</th>
                            <th>Expression Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedTissues.map(([tissue, nTPM]) => {
                            const level = getExpressionLevel(nTPM);
                            const levelClass = getExpressionLevelClass(nTPM);
                            return `
                                <tr>
                                    <td>${tissue}</td>
                                    <td>${nTPM.toFixed(2)}</td>
                                    <td><span class="expression-value ${levelClass}">${level}</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            tableWrapper.innerHTML = tableHTML;
        }
        
        // Get expression level description
        function getExpressionLevel(nTPM) {
            if (nTPM <= 5) return 'Low';
            if (nTPM <= 15) return 'Medium';
            if (nTPM <= 30) return 'High';
            return 'Very High';
        }
        
        // Get expression level CSS class
        function getExpressionLevelClass(nTPM) {
            if (nTPM <= 5) return 'expression-low';
            if (nTPM <= 15) return 'expression-medium';
            if (nTPM <= 30) return 'expression-high';
            return 'expression-very-high';
        }
        
        // Get expression color based on nTPM value
        function getExpressionColor(nTPM) {
            if (nTPM <= 5) return '#A8E6A1';      // Light green - Low expression (0-5 nTPM)
            if (nTPM <= 15) return '#6CC96C';     // Medium green - Medium expression (5-15 nTPM)
            if (nTPM <= 30) return '#3FAF3F';     // Green - High expression (15-30 nTPM)
            return '#1E7B1E';                      // Dark green - Very high expression (>30 nTPM)
        }
        
        // Show error message
        function showError(message) {
            const tableWrapper = document.getElementById('expression-table-wrapper');
            tableWrapper.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // Load and prepare the SVG file for organ identification
        async function loadSVGFile() {
            try {
                const response = await fetch('file.svg');
                if (!response.ok) throw new Error('Failed to load SVG file');
                
                const svgText = await response.text();
                const container = document.getElementById('svg-container');
                if (!container) return;
                
                // Insert the SVG content
                container.innerHTML = svgText;
                
                // Prepare organs for expression visualization
                prepareOrgansForExpression();
                
                console.log('SVG file loaded successfully');
            } catch (error) {
                console.error('Error loading SVG file:', error);
                const container = document.getElementById('svg-container');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #e74c3c;">Error loading SVG file. Please check if file.svg exists.</div>';
                }
            }
        }
        
        // Prepare organs in the SVG for expression visualization
        function prepareOrgansForExpression() {
            // Map tissue names from TSV to SVG path elements based on their colors
            // Using exact tissue names from rna_tissue_consensus.tsv for perfect matching
            const organMappings = [
                // Brain regions - Dark Red (#BE0405)
                { tissue: 'cerebral cortex', selector: 'path[fill="#BE0405"]', description: 'Cerebral Cortex', originalColor: '#BE0405' },
                { tissue: 'cerebellum', selector: 'path[fill="#BE0405"]', description: 'Cerebellum', originalColor: '#BE0405' },
                { tissue: 'amygdala', selector: 'path[fill="#BE0405"]', description: 'Amygdala', originalColor: '#BE0405' },
                { tissue: 'hippocampal formation', selector: 'path[fill="#BE0405"]', description: 'Hippocampus', originalColor: '#BE0405' },
                { tissue: 'hypothalamus', selector: 'path[fill="#BE0405"]', description: 'Hypothalamus', originalColor: '#BE0405' },
                { tissue: 'midbrain', selector: 'path[fill="#BE0405"]', description: 'Midbrain', originalColor: '#BE0405' },
                
                // Heart - Red (#F07070)
                { tissue: 'heart muscle', selector: 'path[fill="#F07070"]', description: 'Heart', originalColor: '#F07070' },
                
                // Lungs - Light Pink (#F6A2A0)
                { tissue: 'lung', selector: 'path[fill="#F6A2A0"]', description: 'Lungs', originalColor: '#F6A2A0' },
                
                // Liver - Pink (#F8A19F)
                { tissue: 'liver', selector: 'path[fill="#F8A19F"]', description: 'Liver', originalColor: '#F8A19F' },
                
                // Stomach - Yellow (#FDE098)
                { tissue: 'stomach', selector: 'path[fill="#FDE098"]', description: 'Stomach', originalColor: '#FDE098' },
                
                // Kidneys - Light Red (#EA8F8E)
                { tissue: 'kidney', selector: 'path[fill="#EA8F8E"]', description: 'Kidneys', originalColor: '#EA8F8E' },
                
                // Intestines - Brown (#C07F54)
                { tissue: 'colon', selector: 'path[fill="#C07F54"]', description: 'Colon', originalColor: '#C07F54' },
                { tissue: 'small intestine', selector: 'path[fill="#C07F54"]', description: 'Small Intestine', originalColor: '#C07F54' },
                { tissue: 'duodenum', selector: 'path[fill="#C07F54"]', description: 'Duodenum', originalColor: '#C07F54' },
                
                // Reproductive organs - Purple (#E49BDC)
                { tissue: 'testis', selector: 'path[fill="#E49BDC"]', description: 'Testis', originalColor: '#E49BDC' },
                { tissue: 'ovary', selector: 'path[fill="#E49BDC"]', description: 'Ovary', originalColor: '#E49BDC' },
                { tissue: 'epididymis', selector: 'path[fill="#E49BDC"]', description: 'Epididymis', originalColor: '#E49BDC' },
                { tissue: 'fallopian tube', selector: 'path[fill="#E49BDC"]', description: 'Fallopian Tube', originalColor: '#E49BDC' },
                { tissue: 'cervix', selector: 'path[fill="#E49BDC"]', description: 'Cervix', originalColor: '#E49BDC' },
                { tissue: 'endometrium', selector: 'path[fill="#E49BDC"]', description: 'Endometrium', originalColor: '#E49BDC' },
                
                // Glands - Various colors
                { tissue: 'adrenal gland', selector: 'path[fill="#F89794"]', description: 'Adrenal Gland', originalColor: '#F89794' },
                { tissue: 'parathyroid gland', selector: 'path[fill="#F89794"]', description: 'Parathyroid Gland', originalColor: '#F89794' },
                { tissue: 'pituitary gland', selector: 'path[fill="#F89794"]', description: 'Pituitary Gland', originalColor: '#F89794' },
                { tissue: 'salivary gland', selector: 'path[fill="#F89794"]', description: 'Salivary Gland', originalColor: '#F89794' },
                { tissue: 'thyroid gland', selector: 'path[fill="#F89794"]', description: 'Thyroid Gland', originalColor: '#F89794' },
                
                // Other organs
                { tissue: 'breast', selector: 'path[fill="#FBD4E6"]', description: 'Breast', originalColor: '#FBD4E6' },
                { tissue: 'pancreas', selector: 'path[fill="#F89794"]', description: 'Pancreas', originalColor: '#F89794' },
                { tissue: 'spleen', selector: 'path[fill="#D77775"]', description: 'Spleen', originalColor: '#D77775' },
                { tissue: 'gallbladder', selector: 'path[fill="#E37733"]', description: 'Gallbladder', originalColor: '#E37733' },
                { tissue: 'appendix', selector: 'path[fill="#F0B18D"]', description: 'Appendix', originalColor: '#F0B18D' },
                { tissue: 'urinary bladder', selector: 'path[fill="#AA1415"]', description: 'Bladder', originalColor: '#AA1415' },
                { tissue: 'prostate', selector: 'path[fill="#853E10"]', description: 'Prostate', originalColor: '#853E10' },
                
                // Adipose tissue
                { tissue: 'adipose tissue', selector: 'path[fill="#F6D3C3"]', description: 'Adipose Tissue', originalColor: '#F6D3C3' }
            ];
            
            const svg = document.querySelector('#svg-container svg');
            if (!svg) return;
            
            // Apply organ class and prepare for expression visualization
            organMappings.forEach((mapping, index) => {
                const pathElements = svg.querySelectorAll(mapping.selector);
                if (pathElements.length > 0) {
                    pathElements.forEach((pathElement, pathIndex) => {
                                                 // Add organ class and tissue identifier
                         pathElement.classList.add('organ');
                         pathElement.setAttribute('data-tissue', mapping.tissue);
                         pathElement.setAttribute('data-description', mapping.description);
                         pathElement.setAttribute('data-original-color', mapping.originalColor);
                         
                         // Set initial styling
                         pathElement.style.cursor = 'pointer';
                         pathElement.style.transition = 'all 0.3s ease';
                         pathElement.style.stroke = '#2c5aa0';
                         pathElement.style.strokeWidth = '2';
                         
                         // Add hover effects
                         pathElement.addEventListener('mouseenter', () => {
                             pathElement.style.filter = 'brightness(1.2)';
                         });
                         pathElement.addEventListener('mouseleave', () => {
                             pathElement.style.filter = 'brightness(1)';
                         });
                         
                         // Add click event for organ selection
                         pathElement.addEventListener('click', () => {
                             handleOrganClick(mapping.tissue, mapping.description);
                         });
                    });
                }
            });
            
            console.log('Organs prepared for expression visualization with click functionality');
        }
        
        // Handle organ click to filter expression data by tissue
        function handleOrganClick(tissueName, description) {
            // Highlight the clicked organ
            highlightClickedOrgan(tissueName);
            
            // Filter and display expression data for this tissue
            displayTissueExpressionData(tissueName, description);
        }
        
        // Highlight the clicked organ
        function highlightClickedOrgan(tissueName) {
            const organs = document.querySelectorAll('.organ');
            organs.forEach(organ => {
                // Reset all organs to default state
                organ.style.stroke = '#2c5aa0';
                organ.style.strokeWidth = '2';
                organ.style.filter = 'brightness(1)';
                
                // Highlight the clicked organ
                if (organ.getAttribute('data-tissue') === tissueName) {
                    organ.style.stroke = '#e74c3c';
                    organ.style.strokeWidth = '3';
                    organ.style.filter = 'brightness(1.1)';
                }
            });
        }
        
        // Display expression data filtered by tissue
        function displayTissueExpressionData(tissueName, description) {
            const tableWrapper = document.getElementById('expression-table-wrapper');
            if (!tableWrapper) return;
            
            // Find all genes with expression data for this tissue
            const tissueExpressionData = [];
            
            if (expressionData && Object.keys(expressionData).length > 0) {
                Object.entries(expressionData).forEach(([geneName, tissueData]) => {
                    if (tissueData[tissueName] && !isNaN(tissueData[tissueName])) {
                        const nTPM = parseFloat(tissueData[tissueName]);
                        
                        tissueExpressionData.push({
                            gene: geneName,
                            tissue: tissueName,
                            nTPM: nTPM,
                            level: getExpressionLevel(nTPM)
                        });
                    }
                });
            }
            
            // Sort by expression level (highest first)
            tissueExpressionData.sort((a, b) => b.nTPM - a.nTPM);
            
            if (tissueExpressionData.length === 0) {
                tableWrapper.innerHTML = `
                    <div class="no-data">
                        No expression data available for ${description}
                    </div>`;
                return;
            }
            
            // Display the filtered data
            const tableHTML = `
                <div style="margin-bottom: 1rem;">
                    <h5 style="color: #2c5aa0; margin-bottom: 0.5rem;">
                        ${description} Expression Data (${tissueExpressionData.length} genes)
                    </h5>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                        Click on a gene to see its full expression profile across all tissues
                    </p>
                </div>
                <table class="expression-table" style="width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                    <thead>
                        <tr>
                            <th style="padding: 0.8rem; text-align: left; border-bottom: 1px solid #e1ecf4; background: #2c5aa0; color: white; font-weight: 600;">Gene</th>
                            <th style="padding: 0.8rem; text-align: left; border-bottom: 1px solid #e1ecf4; background: #2c5aa0; color: white; font-weight: 600;">nTPM Value</th>
                            <th style="padding: 0.8rem; text-align: left; border-bottom: 1px solid #e1ecf4; background: #2c5aa0; color: white; font-weight: 600;">Expression Level</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tissueExpressionData.slice(0, 50).map((item, index) => {
                            const levelClass = getExpressionLevelClass(item.nTPM);
                            const geneColor = getExpressionColor(item.nTPM);
                            return `
                                <tr style="cursor: pointer; background-color: ${geneColor}; transition: all 0.2s ease;" 
                                    onclick="selectGeneFromTable('${item.gene}')"
                                    onmouseover="this.style.filter='brightness(1.1)'"
                                    onmouseout="this.style.filter='brightness(1)'">
                                    <td style="padding: 0.8rem; text-align: left; border-bottom: 1px solid #e1ecf4; font-weight: 600; color: #1E7B1E;">${item.gene}</td>
                                    <td style="padding: 0.8rem; text-align: left; border-bottom: 1px solid #e1ecf4; color: #1E7B1E;">${item.nTPM.toFixed(2)}</td>
                                    <td style="padding: 0.8rem; text-align: left; border-bottom: 1px solid #e1ecf4;"><span class="expression-value ${levelClass}">${item.level}</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                ${tissueExpressionData.length > 50 ? `
                    <div style="text-align: center; margin-top: 1rem; color: #666; font-size: 0.9rem;">
                        Showing top 50 genes. Total: ${tissueExpressionData.length} genes
                    </div>
                ` : ''}
            `;
            
            tableWrapper.innerHTML = tableHTML;
        }
        
        // Select gene from tissue expression table
        function selectGeneFromTable(geneName) {
            // Update search input
            const searchInput = document.getElementById('gene-search');
            if (searchInput) {
                searchInput.value = geneName;
            }
            
            // Show gene info
            showGeneInfo(geneName);
            
            // Update expression visualization for this gene
            updateExpressionVisualization(geneName);
            
            // Update the full expression table
            updateExpressionTable(geneName);
        }
        
        // Reset organ selection and restore default state
        function resetOrganSelection() {
            // Reset all organs to their original colors
            const organs = document.querySelectorAll('.organ');
            organs.forEach(organ => {
                const originalColor = organ.getAttribute('data-original-color');
                if (originalColor) {
                    organ.setAttribute('fill', originalColor);
                }
                organ.setAttribute('title', '');
                organ.style.stroke = '#2c5aa0';
                organ.style.strokeWidth = '2';
                organ.style.filter = 'brightness(1)';
            });
            
            // Reset the expression table
            const tableWrapper = document.getElementById('expression-table-wrapper');
            if (tableWrapper) {
                tableWrapper.innerHTML = `
                    <div class="no-data">
                        Click on an organ to see its gene expression data, or search for a specific gene
                    </div>`;
            }
            
            // Clear selected gene info
            const selectedGeneInfoDiv = document.getElementById('selected-gene-info');
            if (selectedGeneInfoDiv) {
                selectedGeneInfoDiv.style.display = 'none';
            }
            
            // Clear search input
            const searchInput = document.getElementById('gene-search');
            if (searchInput) {
                searchInput.value = '';
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
