<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Expression Search</title>
    <link rel="stylesheet" href="expression.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Gene Expression Search</h1>
        <div class="search-container">
            <input type="text" id="geneSearch" placeholder="Enter gene name (e.g., TSPAN6)">
            <button onclick="searchGene()">Search</button>
        </div>
        <div id="results" class="results"></div>
    </div>
    <script>
        async function searchGene() {
            const geneName = document.getElementById('geneSearch').value.trim().toUpperCase();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (!geneName) {
                resultsDiv.innerHTML = '<p>Please enter a gene name.</p>';
                return;
            }

            try {
                // Fetch the compressed .gz file
                const response = await fetch('rna_tissue_consensus.json.gz');
                if (!response.ok) throw new Error('Failed to fetch data');

                // Get the response as an array buffer
                const buffer = await response.arrayBuffer();
                
                // Decompress the gzip file using pako
                const decompressed = pako.inflate(new Uint8Array(buffer), { to: 'string' });
                
                // Parse the decompressed JSON
                const data = JSON.parse(decompressed);
                
                // Filter data by gene name
                const geneData = data.filter(entry => entry['Gene name'].toUpperCase() === geneName);

                if (geneData.length === 0) {
                    resultsDiv.innerHTML = '<p>No data found for gene: ' + geneName + '</p>';
                    return;
                }

                // Create table for results
                const table = document.createElement('table');
                const header = table.insertRow();
                header.innerHTML = '<th>Tissue</th><th>nTPM</th>';

                geneData.forEach(entry => {
                    const row = table.insertRow();
                    const nTPM = parseFloat(entry.nTPM);
                    let greenIntensity = Math.min(255, Math.floor(nTPM * 5)); // Scale nTPM to green intensity
                    const cellTissue = row.insertCell();
                    cellTissue.textContent = entry.Tissue;
                    cellTissue.style.backgroundColor = `rgb(0, ${greenIntensity}, 0)`;
                    cellTissue.style.color = greenIntensity > 128 ? 'black' : 'white'; // Adjust text color for readability
                    row.insertCell().textContent = nTPM.toFixed(1);
                });

                resultsDiv.appendChild(table);
            } catch (error) {
                resultsDiv.innerHTML = '<p>Error loading data. Please try again.</p>';
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
